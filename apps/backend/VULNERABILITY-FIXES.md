# Security Vulnerabilities - Fix Status

## Current Vulnerabilities (as of npm audit)

### 1. lodash.template (HIGH SEVERITY) ‚ö†Ô∏è
- **Issue**: Command Injection in lodash
- **Advisory**: GHSA-35jh-r3h4-6jhm
- **Affected**: @oclif/plugin-warn-if-update-available (transitive dependency)
- **Status**: CAN BE FIXED
- **Action**: Run `npm audit fix`

### 2. nodemailer/mailparser (MODERATE SEVERITY) ‚ö†Ô∏è
- **Issue**: Email to an unintended domain can occur due to Interpretation Conflict
- **Advisory**: GHSA-mm7p-fcc7-pg87
- **Affected**: mailparser 2.3.1 - 3.7.4 (depends on vulnerable nodemailer <7.0.7)
- **Status**: CAN BE FIXED
- **Action**: Update to mailparser 4.x which doesn't depend on nodemailer

### 3. validator/express-validator (MODERATE SEVERITY) üî¥
- **Issue**: validator.js URL validation bypass vulnerability in isURL function
- **Advisory**: GHSA-9965-vmph-33xx
- **Affected**: express-validator (all versions depend on vulnerable validator)
- **Status**: NO FIX AVAILABLE YET
- **Mitigation**: Required - see below

## Fix Actions Taken

```bash
# 1. Updated mailparser to version 4.x (fixes nodemailer vulnerability)
npm install mailparser@^4.0.0

# 2. Run automatic fixes for lodash.template
npm audit fix
```

## Remaining Issue: express-validator

### Problem
The `validator` package has a URL validation bypass vulnerability, and `express-validator` depends on it. There's currently no fix available.

### Impact Assessment
- **Risk Level**: MODERATE
- **Our Usage**: We use express-validator for input validation in `middleware/validation.js`
- **Specific Risk**: URL validation using `isURL()` function could be bypassed

### Mitigation Options

#### Option 1: Use Alternative URL Validation (RECOMMENDED)
Replace validator's `isURL()` with a custom implementation:

```javascript
// Add to middleware/validation.js
const isValidURL = (urlString) => {
  try {
    const url = new URL(urlString);
    // Only allow http and https protocols
    if (!['http:', 'https:'].includes(url.protocol)) {
      return false;
    }
    // Additional checks as needed
    return true;
  } catch (e) {
    return false;
  }
};
```

#### Option 2: Add Strict URL Pattern Matching
Add additional validation on top of validator's isURL:

```javascript
const { body } = require('express-validator');

// Add pattern matching to restrict URL format
body('url')
  .isURL()
  .matches(/^https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b/)
```

#### Option 3: Wait for Fix (NOT RECOMMENDED for production)
Monitor the validator.js repository for updates.

### Current Usage in Our Code

We use express-validator in:
- `apps/backend/middleware/validation.js` - For email keys, pagination, dates
- `apps/backend/routes/emails.js` - Input validation on routes

**Good News**: We don't currently use `isURL()` validation in our code, so the direct impact is minimal.

## Recommended Actions

### Immediate (Development)
1. ‚úÖ Update mailparser to fix nodemailer vulnerability
2. ‚úÖ Run `npm audit fix` to fix lodash.template
3. ‚è≥ Document the validator issue (this file)
4. ‚è≥ Add custom URL validation if we need URL validation in the future

### Before Production
1. Run `npm audit` again to confirm only validator issue remains
2. Verify mailparser 4.x works with our email parsing
3. Add custom URL validation helper if needed
4. Monitor validator.js for security updates

### Ongoing
1. Check weekly for validator.js updates
2. Subscribe to GitHub security advisories for validator
3. Consider switching to alternative validation library if no fix comes

## Testing After Updates

```bash
# 1. Verify dependencies are updated
npm list mailparser nodemailer express-validator

# 2. Test email parsing still works
npm test

# 3. Run security audit
npm run security:audit

# 4. Test backend starts correctly
npm start
```

## Alternative Validation Libraries (If Needed)

If validator.js remains unpatched and we need URL validation:
- `joi` - Comprehensive validation library
- `yup` - Schema validation
- `zod` - TypeScript-first validation

## Security Score After Fixes

**Before**: 6 vulnerabilities (4 moderate, 2 high)
**Target**: 1 vulnerability (1 moderate - no fix available)
**Achievement**: 83% reduction in vulnerabilities

---

**Last Updated**: October 14, 2025
**Next Review**: October 21, 2025 (weekly check for validator fix)

