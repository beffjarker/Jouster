name: RS Cypress Smoke

on:
  schedule:
    - cron: '0 12 * * *' # runs every day at 12PM UTC

env:
  NODE_VERSION: '20.19.0'
  NODE_OPTIONS: '--max_old_space_size=7168'

jobs:
  cy-prep:
    runs-on: ubuntu-latest
    outputs:
      author: ${{ steps.cy-info.outputs.author }}
      branch: ${{ steps.base.outputs.name }}
      build-id: ${{ steps.cy-info.outputs.build-id }}
      email: ${{ steps.cy-info.outputs.email }}
      message: ${{ steps.cy-info.outputs.message }}
      remote: ${{ steps.cy-info.outputs.remote }}
      sha: ${{ steps.cy-info.outputs.sha }}
      projects: ${{ steps.instances.outputs.projects }}
      has-projects: ${{ steps.cy-info.outputs.has-projects }}
      tag: '@smoke'
    steps:
      - name: ‚úîÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üîë Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        if: ${{ ! env.AWS_ACCESS_KEY_ID }}
        with:
          aws-access-key-id: ${{ secrets.AWS_NONPROD_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_NONPROD_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: üéÅ Get Affected Base and Smoke Tag
        id: base
        run: |
          BASE="master"
          if [[ $BASE == "master" ]]; then
            BASE="remotes/origin/master"
          else
            BASE="remotes/origin/$GITHUB_BASE_REF"
          fi
          echo "name=${BASE}" >> $GITHUB_OUTPUT
          TAG="@smoke"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: üéÅ Get Necessary Cypress information
        id: cy-info
        run: |
          AUTHOR=$(git log -1 --pretty=%an)
          EMAIL=$(git log -1 --pretty=%ae)
          MESSAGE=$(git log -1 --pretty=%B)
          TAG='@smoke'
          PROJECTS=$(./bin/cy-manual-projects-json.sh)
          echo $PROJECTS | jq -M
          HAS_PROJECTS=$(echo $PROJECTS | jq 'length > 0')
          echo $HAS_PROJECTS
          REMOTE=$(git config --get remote.origin.url)
          SHA=$(git log -1 --pretty=%H)
          echo "author=${AUTHOR}" >> $GITHUB_OUTPUT
          echo "email=${EMAIL}" >> $GITHUB_OUTPUT
          echo "build-id=${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_OUTPUT
          echo "message=${MESSAGE}" >> $GITHUB_OUTPUT
          echo "projects=${PROJECTS}" >> $GITHUB_OUTPUT
          echo "has-projects=${HAS_PROJECTS}" >> $GITHUB_OUTPUT
          echo "remote=${REMOTE}" >> $GITHUB_OUTPUT
          echo "sha=${SHA}" >> $GITHUB_OUTPUT

      - name: ‚ôæÔ∏è Set Instances
        id: instances
        run: |
          PROJECTS=$(./bin/set-instances-rs-manual.sh 'rs-frontend-e2e' '@smoke' 4)
          echo "Before assigning projects output"
          echo "projects=${PROJECTS}" >> $GITHUB_OUTPUT

  smoke-tests:
    name: smoke-tests (${{ matrix.projects.id }})
    needs: [cy-prep]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.cy-prep.outputs.projects) }}

    steps:
      - name: Process Build Id
        id: build-id
        run: |
          echo ${{ matrix.projects.target.project }}
          echo ${{ needs.cy-prep.outputs.build-id }}
          echo "build-id=${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_OUTPUT

      - name: üñ®Ô∏è Print needed info
        run: |
          echo "Needed Information"
          echo "author: ${{ needs.cy-prep.outputs.author }}"
          echo "branch: ${{ needs.cy-prep.outputs.branch }}"
          echo "build-id": ${{ steps.build-id.outputs.build-id }}
          echo "email: ${{ needs.cy-prep.outputs.email }}"
          echo "message: ${{ needs.cy-prep.outputs.message }}"
          echo "project: ${{ matrix.projects.target.project }}"
          echo "configuration: ${{ matrix.projects.target.configuration }}"
          echo "remote: ${{ needs.cy-prep.outputs.remote }}"
          echo "sha: ${{ needs.cy-prep.outputs.sha }}"
          echo "record key: ${{ needs.cy-prep.outputs.record-key }}"
          echo "tag: ${{ needs.cy-prep.outputs.tag }}"
          echo "stage: ${{ matrix.projects.overrides.stage }}"

      - name: üéÅ Cypress Cloud Record Key Secret Name
        id: cy-cloud
        run: |
          RECORD_KEY=$(echo "${{matrix.projects.target.project}}_RECORD_KEY" | sed -e "s/-/_/g" | tr '[:lower:]' '[:upper:]')
          echo "RECORD_KEY: ${RECORD_KEY}"
          echo "record-key=${RECORD_KEY}" >> $GITHUB_OUTPUT

      - name: ‚úîÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üîë Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_NONPROD_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_NONPROD_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: üß™ Cypress Tests (UI) [Non-RIES Hub]
        if: ${{ startsWith(matrix.projects.target.project, 'rs') && endsWith(matrix.projects.target.project, 'e2e') }}
        id: codebuild
        uses: aws-actions/aws-codebuild-run-build@v1.0.16
        with:
          project-name: digital-platform-ries-hub-api-ui-test-nonprod-codebuild
          buildspec-override: scripts/codebuild/cypress-rs-buildspec.yml
          env-vars-for-codebuild: |
            AUTHOR,
            BRANCH,
            BUILD_ID,
            EMAIL,
            MESSAGE,
            PROJECT,
            CONFIGURATION,
            REMOTE,
            REPUBLIC_SYSTEM_PAT,
            SHA,
            TAG,
            STAGE,
            RECORD_KEY,
        env:
          AUTHOR: ${{ needs.cy-prep.outputs.author }}
          BRANCH: ${{ needs.cy-prep.outputs.branch }}
          BUILD_ID: ${{ steps.build-id.outputs.build-id }}
          EMAIL: ${{ needs.cy-prep.outputs.email }}
          MESSAGE: ${{ needs.cy-prep.outputs.message }}
          PROJECT: ${{ matrix.projects.target.project }}
          CONFIGURATION: ${{ matrix.projects.target.configuration }}
          REMOTE: ${{ needs.cy-prep.outputs.remote }}
          REPUBLIC_SYSTEM_PAT: ${{ secrets.REPUBLIC_SYSTEM_PAT }}
          SHA: ${{ needs.cy-prep.outputs.sha }}
          TAG: '${{ needs.cy-prep.outputs.tag }}'
          STAGE: ${{ matrix.projects.overrides.stage }}
          RECORD_KEY: ${{ secrets[steps.cy-cloud.outputs.record-key] }}

  cypress-status:
    if: ${{ !cancelled() }}
    needs: [cy-prep, smoke-tests]
    runs-on: ubuntu-latest
    steps:
      - name: üñ®Ô∏è print cypress-smoke-tests result
        run: |
          echo "has-projects: ${{ needs.cy-prep.outputs.has-projects }}"
          echo "result: ${{ needs.smoke-tests.result }}"
          echo "proceed: ${{ needs.cy-prep.outputs.has-projects == 'false' || needs.smoke-tests.result == 'success' }}"

      - name: ‚úîÔ∏è Check Cypress Matrix status
        if: ${{ needs.cy-prep.outputs.has-projects == 'true' && needs.smoke-tests.result != 'success' }}
        run: exit 1
