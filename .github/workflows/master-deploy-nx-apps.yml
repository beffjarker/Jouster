name: Deploy Nx Apps (master)

env:
  NODE_VERSION: '20.19.0'

permissions:
  id-token: write
  contents: read

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths-ignore:
      - '/apps/ries-hub-marklogic-dhs/**'
      - '/apps/km-marklogic-dhs/**'

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    # Sanity check to only run for the default branch to prevent accidental runs from other branches
    if: github.ref_name == github.event.repository.default_branch
    outputs:
      projects: ${{ steps.projects.outputs.projects }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get Apps
        id: projects
        run: |
          PROJECTS=($(bin/get-apps.js -a));
          PROJECTS_JSON=$(jq --compact-output --null-input '$ARGS.positional' --args -- "${PROJECTS[@]}" | jq -c -M '{"project": . }');
          echo "projects=${PROJECTS_JSON}" >> $GITHUB_OUTPUT
          echo ""
          echo "Projects to deploy:"
          echo ${PROJECTS[@]}

  deploy:
    name: deploy (${{ matrix.project }})
    needs: setup
    runs-on: ubuntu-latest
    # Sanity check to only run for the default branch to prevent accidental runs from other branches
    if: github.ref_name == github.event.repository.default_branch
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.projects) }}

    env:
      # RIES Hub roles (TBD, as these apps are still in the legacy nonprod/prod accounts)
      # RIES_HUB_OIDC_SSO_DEV_ROLE: ${{ secrets.RIES_HUB_OIDC_SSO_DEV_ROLE }}
      # DEV environment roles (for AURA, RScom, etc.)
      AURA_OIDC_SSO_DEV_ROLE: ${{ secrets.AURA_OIDC_SSO_DEV_ROLE }}
      RSCOM_OIDC_SSO_DEV_ROLE: ${{ secrets.RSCOM_OIDC_SSO_DEV_ROLE }}
      # QA environment roles (for ECom)
      ECOM_OIDC_SSO_QA_ROLE: ${{ secrets.ECOM_OIDC_SSO_QA_ROLE }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure AWS Credentials
        uses: ./.github/actions/configure-aws-credentials
        with:
          project: ${{ matrix.project }}
          environment: ${{ startsWith(matrix.project, 'ecom-') && 'qa' || 'dev' }}
          aws-region: 'us-west-2'
          fallback-access-key-id: ${{ secrets.AWS_NONPROD_ACCESS_KEY_ID }}
          fallback-secret-access-key: ${{ secrets.AWS_NONPROD_SECRET_ACCESS_KEY }}

      # Uses nx run-many so we can use the --configuration option (if a project doesn't have a given config it bails otherwise)
      - name: Create Infrastructure
        env:
          ENVIRONMENT: qa
          STAGE: master
          NODE_OPTIONS: '--max_old_space_size=7168'
          REMOTE_BASE_URL: '-master.rscom-nonprod.awsext.repsrv.com'
          AURA_UI_BASE_URL: '-master.aura-nonprod.awsext.repsrv.com'
          UNIFIED_WP_UI_BASE_URL: '-master.aura-nonprod.awsext.repsrv.com'
          REPORTING_UI_BASE_URL: '-master.aura-nonprod.awsext.repsrv.com'
          RSW_UI_BASE_URL: '-master.rscom-nonprod.awsext.repsrv.com'
          SM_UI_BASE_URL: '-master.rscom-nonprod.awsext.repsrv.com'
          AURA_ENABLED: true
          WASTE_PROFILE_ENABLED: true
          REPORTING_ENABLED: true
          RSW_ACCOUNT_ENABLED: true
          SM_UI_ENABLED: true
          TABLE_NAME: reporting-users-master

        run: |
          npx nx run-many \
            --projects=${{matrix.project}} \
            --target=deploy \
            --configuration=master \
            --stage=master

      - name: Seed DynamoDB Table With Test Data
        if: contains(fromJson('["ries-hub-data"]'), matrix.project)
        run: |
          npx ts-node scripts/dynamo/seed-table.ts --stage=master
