name: AWS Housekeeping (alpha)

env:
  NODE_VERSION: '20.12.1'

on:
  # schedule:
  #   - cron: '0 6 * * 1' # Run every Monday at 6 AM UTC
  workflow_dispatch:

concurrency:
  group: aws-housekeeping
  cancel-in-progress: false

jobs:
  housekeeping:
    name: Run AWS Housekeeping Script
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        region:
          - us-east-1
          - us-west-2
        role:
          - ${{ vars.RSCOM_OIDC_SSO_DEV_ROLE }}
          - ${{ vars.ECOM_OIDC_SSO_DEV_ROLE }}
          - ${{ vars.AURA_OIDC_SSO_DEV_ROLE }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ matrix.role }}
          role-session-name: 'github_actions-housekeeping-nonprod'
          aws-region: us-west-2

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run AWS Housekeeping Script
        run: scripts/fix-failed-deletion.js --region ${{ matrix.region }}
