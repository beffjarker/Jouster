name: UWP COR API E2E Scheduled

on:
  schedule:
    # Run uwp-cor-api-e2e at 04:30 UTC on weekdays
    - cron: '30 4 * * 0-4'
  workflow_dispatch:

env:
  NODE_VERSION: '20.19.0'
  TAG: '@regression'
  BROWSER: 'chrome'
  TESTS_PER_MACHINE: '10'
  TEST_ENV: 'qa'
  BASEURL: 'https://aura-waste-profile-api-us-west-2.aura-nonprod.awsext.repsrv.com/master-uwp-cor-api'
  PROJECT: 'uwp-cor-api-e2e'

permissions:
  id-token: write
  contents: read

jobs:
  environment:
    runs-on: ubuntu-latest
    steps:
      - name: Environment Information
        run: |
          echo '### UWP COR API Scheduled Test Execution' >> $GITHUB_STEP_SUMMARY
          echo "**Project:** UWP COR API" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ env.TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "**Browser:** ${{ env.BROWSER }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.TEST_ENV }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tests per machine:** ${{ env.TESTS_PER_MACHINE }}" >> $GITHUB_STEP_SUMMARY

  cy-prep:
    runs-on: ubuntu-latest
    outputs:
      author: ${{ steps.cy-info.outputs.author }}
      branch: ${{ github.ref_name }}
      build-id: ${{ steps.cy-info.outputs.build-id }}
      email: ${{ steps.cy-info.outputs.email }}
      env: ${{ env.TEST_ENV }}
      message: ${{ steps.cy-info.outputs.message }}
      remote: ${{ steps.cy-info.outputs.remote }}
      sha: ${{ steps.cy-info.outputs.sha }}
      projects: ${{ env.PROJECT }}
      browser: ${{ env.BROWSER }}
      tag: ${{ env.TAG }}
      instances: ${{ steps.instances.outputs.instances }}

    steps:
      - name: ‚úîÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üéÅ Get Necessary Cypress information
        id: cy-info
        run: |
          AUTHOR=$(git log -1 --pretty=%an)
          EMAIL=$(git log -1 --pretty=%ae)
          BROWSER=${{ env.BROWSER }}
          TAG=${{ env.TAG }}
          PROJECTS=${{ env.PROJECT }}
          REMOTE=$(git config --get remote.origin.url)
          SHA=$(git log -1 --pretty=%H)
          echo "author=${AUTHOR}" >> $GITHUB_OUTPUT
          echo "email=${EMAIL}" >> $GITHUB_OUTPUT
          echo "build-id=${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_OUTPUT
          echo "projects=${PROJECTS}" >> $GITHUB_OUTPUT
          echo "remote=${REMOTE}" >> $GITHUB_OUTPUT
          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "browser=${BROWSER}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "message<<$EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=%B >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: ‚ôæÔ∏è Set Instances
        id: instances
        run: |
          # Debug information
          echo "Debug: Starting Set Instances"
          echo "TESTS_PER_MACHINE: ${{ env.TESTS_PER_MACHINE }}"
          echo "PROJECT: ${{ env.PROJECT }}"
          echo "TAG: ${{ env.TAG }}"

          # arguments
          TESTS_PER_MACHINE=${{ env.TESTS_PER_MACHINE }}

          # Get specs for the project and tag
          SPECS=$(grep -ERl "${{ env.TAG }}" "apps/${{ env.PROJECT }}/src/" | tr '\n' ',')
          SPECS=${SPECS::-1}
          echo "SPECS found: $SPECS"

          # Debug array creation
          echo "Creating SPEC_ARRAY from specs"
          IFS=',' read -ra SPEC_ARRAY <<< "$SPECS"
          echo "Number of specs found: ${#SPEC_ARRAY[@]}"

          # get the number of instances based on the number of spec files and tests per instance
          NUM_INSTANCES=$((${#SPEC_ARRAY[@]} / $TESTS_PER_MACHINE))
          REMAINDER=$((${#SPEC_ARRAY[@]} % $TESTS_PER_MACHINE))

          echo "Debug: NUM_INSTANCES=$NUM_INSTANCES"
          echo "Debug: REMAINDER=$REMAINDER"

          if [ $REMAINDER -gt 0 ]; then
            NUM_INSTANCES=$((NUM_INSTANCES + 1))
            echo "Debug: Added 1 for remainder. New NUM_INSTANCES=$NUM_INSTANCES"
          fi

          # Ensure at least one instance if there are any specs
          if [ ${#SPEC_ARRAY[@]} -gt 0 ] && [ $NUM_INSTANCES -eq 0 ]; then
            NUM_INSTANCES=1
            echo "Debug: Set minimum of 1 instance since specs exist"
          fi

          echo "Final NUM_INSTANCES: $NUM_INSTANCES"

          # create instance strings for matrix
          INSTANCES="["
          for (( i=1; i<=$NUM_INSTANCES; i++ )); do
            INSTANCES+="\"group$i\","
            echo "Debug: Added group$i"
          done
          INSTANCES=${INSTANCES::-1}
          INSTANCES+="]"
          echo "Debug: Final INSTANCES=$INSTANCES"
          echo "instances=${INSTANCES}" >> $GITHUB_OUTPUT

  cypress-tests:
    name: cypress-tests (${{ matrix.GROUP_VARS }})
    needs: [cy-prep]
    runs-on:
      group: self-hosted-nonprod
      labels: nonprod
    strategy:
      fail-fast: false
      matrix:
        GROUP_VARS: ${{ fromJSON(needs.cy-prep.outputs.instances) }}
    outputs:
      cypress_run_number: ${{ steps.extract-run-number.outputs.cypress_run_number }}
      CYPRESS_REPORT_TOKEN: ${{ steps.ssm.outputs.CYPRESS_REPORT_TOKEN }}

    steps:
      - name: Process Build Id
        id: build-id
        run: |
          echo "${{ env.PROJECT }}"
          echo ${{ needs.cy-prep.outputs.build-id }}
          echo "build-id=${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_OUTPUT

      - name: üñ®Ô∏è Print needed info
        run: |
          echo "Needed Information"
          echo "author: ${{ needs.cy-prep.outputs.author }}"
          echo "branch: ${{ github.ref_name }}"
          echo "build-id": ${{ steps.build-id.outputs.build-id }}
          echo "email: ${{ needs.cy-prep.outputs.email }}"
          echo "env: ${{ env.TEST_ENV }}"
          echo "message: ${{ needs.cy-prep.outputs.message }}"
          echo "project: ${{ env.PROJECT }}"
          echo "remote: ${{ needs.cy-prep.outputs.remote }}"
          echo "sha: ${{ needs.cy-prep.outputs.sha }}"
          echo "browser: ${{ env.BROWSER }}"
          echo "tag: ${{ env.TAG }}"
          echo "group: ${{ matrix.GROUP_VARS }}"

      - name: üéÅ Cypress Cloud Record Key Secret Name
        id: cy-cloud
        run: |
          RECORD_KEY=$(echo "${{ env.PROJECT }}_RECORD_KEY" | sed -e "s/-/_/g" | tr '[:lower:]' '[:upper:]')
          echo "RECORD_KEY: ${RECORD_KEY}"
          echo "record-key=${RECORD_KEY}" >> $GITHUB_OUTPUT

      - name: üîë Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.CYPRESS_OIDC_ROLE }}
          role-session-name: 'github_actions-cypress-uwp-cor-api-scheduled'
          aws-region: us-west-2

      - name: Get SSM parameters
        id: ssm
        run: |
          echo "CY_AUTH0_CLIENT_SECRET=$(aws ssm get-parameter --name /digital/github/CY_AUTH0_CLIENT_SECRET --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_OUTPUT
          echo "CYPRESS_REPORT_TOKEN=$(aws ssm get-parameter --name /digital/github/CYPRESS_REPORT_TOKEN --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials (AURA)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AURA_OIDC_SSO_DEV_ROLE }}
          role-session-name: 'github_actions-aura_sso-dev'
          aws-region: us-west-2
          audience: sts.amazonaws.com

      - name: Get SSM parameters
        id: uwp-ssm
        run: |
          echo "UWP_COR_API_X_API_KEY=$(aws ssm get-parameter --name /digital/aura-api/UWP_COR_API_X_API_KEY --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_OUTPUT

      - name: ‚úîÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üß™ Cypress Tests (API) [UWP COR]
        id: cypress
        env:
          AUTHOR: ${{ needs.cy-prep.outputs.author }}
          BRANCH: ${{ needs.cy-prep.outputs.branch }}
          BROWSER: ${{ env.BROWSER }}
          BASE_URL: ${{ env.BASEURL }}
          BUILD_ID: ${{ steps.build-id.outputs.build-id }}
          CY_AUTH0_CLIENT_ID: ${{ vars.CY_AUTH0_CLIENT_ID }}
          CY_AUTH0_CLIENT_SECRET: ${{ steps.ssm.outputs.CY_AUTH0_CLIENT_SECRET }}
          EMAIL: ${{ needs.cy-prep.outputs.email }}
          ENV: ${{ env.TEST_ENV }}
          MESSAGE: ${{ needs.cy-prep.outputs.message }}
          PROJECT: ${{ env.PROJECT }}
          RECORD_KEY: ${{ vars[steps.cy-cloud.outputs.record-key] }}
          REMOTE: ${{ needs.cy-prep.outputs.remote }}
          REPUBLIC_SYSTEM_PAT: ${{ secrets.REPUBLIC_SYSTEM_PAT }}
          SHA: ${{ needs.cy-prep.outputs.sha }}
          TAG: ${{ env.TAG }}
          XAPIKEY: ${{ steps.uwp-ssm.outputs.UWP_COR_API_X_API_KEY }}
        run: |
          npx nx e2e ${{ env.PROJECT }} -- --env.grepTags=${{ env.TAG }} --skipServe=true --record --key=${{ env.RECORD_KEY }} --parallel --ci-build-id ${BUILD_ID} --group CI --browser ${BROWSER} --baseUrl=${{ env.BASE_URL }} --env.env=${{ env.ENV }} --env.CY_AUTH0_CLIENT_ID=${{ env.CY_AUTH0_CLIENT_ID }} --env.CY_AUTH0_CLIENT_SECRET=${{ env.CY_AUTH0_CLIENT_SECRET }} --env.xApiKey=${{ env.XAPIKEY }} | tee cypress-output.log

      - name: Extract Cypress Run Number
        id: extract-run-number
        run: |
          RUN_URL=$(grep -oP 'https://cloud.cypress.io/projects/[a-zA-Z0-9]*/runs/[0-9]*' cypress-output.log | head -1 || echo "")
          RUN_NUMBER=$(echo "$RUN_URL" | grep -o '[0-9]*$')
          if [ -n "$RUN_NUMBER" ]; then
            echo "cypress_run_number=${RUN_NUMBER}" >> "$GITHUB_OUTPUT"
            echo "Extracted Cypress Run Number: $RUN_NUMBER"
          else
            echo "Failed to extract Cypress run number"
            exit 1
          fi

  cypress-extract-results:
    if: ${{ !cancelled() }}
    needs: [cy-prep, cypress-tests]
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.ref_name }}
      CYPRESS_RUN_NUMBER: ${{ needs.cypress-tests.outputs.cypress_run_number }}
      CYPRESS_PROJECT_NAME: digital-platform-uwp-cor-api-e2e
      CYPRESS_REPORT_TOKEN: ${{ needs.cypress-tests.outputs.CYPRESS_REPORT_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üîë Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.CYPRESS_OIDC_ROLE }}
          role-session-name: 'github_actions-cypress-uwp-cor-api-scheduled-extract'
          aws-region: us-west-2

      - name: Extract Test Results
        run: |
          rm -f scripts/extract-regression-results/output/test-results.csv
          npx ts-node scripts/extract-regression-results/extract-cypress-results.ts
        env:
          CYPRESS_REPORT_TOKEN: ${{ needs.cypress-tests.outputs.CYPRESS_REPORT_TOKEN }}
          BRANCH_NAME: ${{ github.ref_name }}
          CYPRESS_RUN_NUMBER: ${{ needs.cypress-tests.outputs.cypress_run_number }}
          CYPRESS_PROJECT_NAME: digital-platform-uwp-cor-api-e2e

      - name: Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-test-results-digital-platform-uwp-cor-api-e2e-${{ needs.cypress-tests.outputs.cypress_run_number }}
          path: scripts/extract-regression-results/output/digital-platform-uwp-cor-api-e2e-${{ needs.cypress-tests.outputs.cypress_run_number }}.csv
          retention-days: 5

  cypress-status:
    if: ${{ !cancelled() }}
    needs: [cy-prep, cypress-tests, cypress-extract-results]
    runs-on: ubuntu-latest
    steps:
      - name: üñ®Ô∏è print cypress test results
        run: |
          echo "project: UWP COR API"
          echo "result: ${{ needs.cypress-tests.result }}"
          echo "proceed: ${{ needs.cypress-tests.result == 'success' }}"

      - name: ‚úîÔ∏è Check Cypress Matrix status
        if: ${{ needs.cypress-tests.result != 'success' }}
        run: exit 1
