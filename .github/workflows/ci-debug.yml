name: CI Debug

on:
  push:
    branches:
      - main
      - develop
  pull_request:

permissions:
  actions: read
  contents: read

jobs:
  # Split the main job into smaller, isolated steps with timeouts
  setup-and-install:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0
        timeout-minutes: 5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
        timeout-minutes: 3

      - name: Install dependencies
        run: |
          echo "Starting npm ci..."
          npm ci
          echo "npm ci completed successfully"
        timeout-minutes: 8

      - name: Install Cypress
        run: |
          echo "Installing Cypress..."
          npx cypress install
          echo "Cypress installation completed"
        timeout-minutes: 5

  lint-and-test:
    needs: setup-and-install
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 8

      - name: Run linting
        run: |
          echo "Starting linting..."
          npx nx run-many -t lint
          echo "Linting completed successfully"
        timeout-minutes: 5

      - name: Run unit tests
        run: |
          echo "Starting unit tests..."
          npx nx run-many -t test
          echo "Unit tests completed successfully"
        timeout-minutes: 10

  build:
    needs: setup-and-install
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 8

      - name: Build applications
        run: |
          echo "Starting build process..."
          npx nx run-many -t build
          echo "Build completed successfully"
        timeout-minutes: 10

  # E2E tests in a separate job with extended timeout
  e2e-tests:
    needs: [setup-and-install, build]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          filter: tree:0
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 8

      - name: Install Cypress
        run: npx cypress install
        timeout-minutes: 5

      - name: Run E2E tests
        run: |
          echo "Starting E2E tests..."
          timeout 25m npx nx run-many -t e2e || echo "E2E tests timed out or failed"
          echo "E2E tests step completed"
        timeout-minutes: 25

  # Dependency validation in a separate job
  dependency-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 8

      - name: Validate dependencies
        run: |
          echo "Checking dependency tree..."
          npm ls --depth=0 || echo "Some dependency issues found"
          echo "Dependency check completed"
        timeout-minutes: 3

      - name: Generate dependency graph
        run: |
          echo "Generating Nx dependency graph..."
          timeout 5m npx nx graph --file=dependency-graph.json || echo "Graph generation timed out"
          echo "Dependency graph step completed"
        timeout-minutes: 5

  # Nx fixes in a separate job
  nx-fixes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        timeout-minutes: 8

      - name: Run Nx fixes
        run: |
          echo "Running Nx CI fixes..."
          npx nx fix-ci || echo "Nx fix-ci completed with warnings"
          echo "Nx fixes completed"
        timeout-minutes: 3
