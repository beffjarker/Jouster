name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [develop]

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.ref != 'develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Clean npm cache and lock files
        run: |
          npm cache clean --force
          rm -f package-lock.json
          rm -rf node_modules

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build application
        run: npm run build:qa

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Preview-${{ github.run_id }}
          aws-region: us-west-2

      - name: Generate preview environment name
        id: preview-env
        run: |
          PR_NUMBER=${{ github.event.number }}
          BRANCH_NAME=${{ github.event.pull_request.head.ref }}
          # Clean branch name for S3 bucket naming
          CLEAN_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
          PREVIEW_NAME="preview-pr-${PR_NUMBER}-${CLEAN_BRANCH}"
          echo "preview_name=${PREVIEW_NAME}" >> $GITHUB_OUTPUT
          echo "bucket_name=jouster-${PREVIEW_NAME}" >> $GITHUB_OUTPUT

      - name: Create S3 bucket for preview
        run: |
          BUCKET_NAME="${{ steps.preview-env.outputs.bucket_name }}"

          # Create bucket
          aws s3 mb s3://$BUCKET_NAME --region us-west-2

          # Configure as static website
          aws s3 website s3://$BUCKET_NAME --index-document index.html --error-document index.html

          # Set public read policy
          cat > bucket-policy.json << EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "PublicReadGetObject",
                "Effect": "Allow",
                "Principal": "*",
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::$BUCKET_NAME/*"
              }
            ]
          }
          EOF

          # Disable block public access
          aws s3api put-public-access-block --bucket $BUCKET_NAME --public-access-block-configuration "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"

          # Apply bucket policy
          aws s3api put-bucket-policy --bucket $BUCKET_NAME --policy file://bucket-policy.json

      - name: Deploy to preview S3 bucket
        run: |
          BUCKET_NAME="${{ steps.preview-env.outputs.bucket_name }}"
          aws s3 sync dist/apps/jouster-ui/ s3://$BUCKET_NAME --delete

      - name: Get preview URL
        id: preview-url
        run: |
          BUCKET_NAME="${{ steps.preview-env.outputs.bucket_name }}"
          PREVIEW_URL="http://$BUCKET_NAME.s3-website-us-west-2.amazonaws.com"
          echo "url=${PREVIEW_URL}" >> $GITHUB_OUTPUT

      - name: Comment on PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.preview-url.outputs.url }}';
            const previewName = '${{ steps.preview-env.outputs.preview_name }}';

            const body = `## ðŸš€ Preview Deployment Ready!

            **Preview URL:** ${previewUrl}
            **Environment:** \`${previewName}\`

            This preview environment will be automatically cleaned up when the PR is merged or closed.

            ### Testing Instructions:
            1. Click the preview URL above
            2. Test your changes in this isolated environment
            3. Check that all features work as expected

            ---
            *This comment will be updated if new commits are pushed to this PR.*`;

            // Find existing preview comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.data.find(
              comment => comment.body.includes('ðŸš€ Preview Deployment Ready!')
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  cleanup-preview:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'

    steps:
      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-Cleanup-${{ github.run_id }}
          aws-region: us-west-2

      - name: Generate preview environment name
        id: preview-env
        run: |
          PR_NUMBER=${{ github.event.number }}
          BRANCH_NAME=${{ github.event.pull_request.head.ref }}
          # Clean branch name for S3 bucket naming
          CLEAN_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
          PREVIEW_NAME="preview-pr-${PR_NUMBER}-${CLEAN_BRANCH}"
          echo "bucket_name=jouster-${PREVIEW_NAME}" >> $GITHUB_OUTPUT

      - name: Cleanup preview S3 bucket
        run: |
          BUCKET_NAME="${{ steps.preview-env.outputs.bucket_name }}"

          # Check if bucket exists before trying to delete
          if aws s3api head-bucket --bucket $BUCKET_NAME 2>/dev/null; then
            echo "Cleaning up preview bucket: $BUCKET_NAME"
            # Empty bucket first
            aws s3 rm s3://$BUCKET_NAME --recursive
            # Delete bucket
            aws s3 rb s3://$BUCKET_NAME
            echo "Preview environment cleaned up successfully"
          else
            echo "Preview bucket $BUCKET_NAME does not exist, skipping cleanup"
          fi
