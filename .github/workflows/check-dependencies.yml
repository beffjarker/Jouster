name: Check Affected Applications

env:
  NODE_VERSION: '20.19.0'

on:
  pull_request:
    paths:
      - 'libs/**'
      - 'apps/**'

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    # TEMPORARILY DISABLED: npm install takes >30 minutes on GitHub Actions
    # Re-enable once dependency installation is optimized
    if: false
    permissions:
      contents: read
      pull-requests: write
    outputs:
      affected_output: ${{ steps.check.outputs.affected_output }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          filter: tree:0

      - name: Set up git base branch
        run: |
          git remote set-branches --add origin ${{ github.base_ref }}
          git fetch origin ${{ github.base_ref }}

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}
          install-command: 'npm ci --legacy-peer-deps --omit=optional --prefer-offline --no-audit'

      - name: Find affected applications
        id: check
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
        run: |
          output=$(node ./scripts/check-dependencies.js)
          echo "affected_output<<EOF" >> $GITHUB_OUTPUT
          echo "$output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Find Comment
        uses: peter-evans/find-comment@v3
        id: fc
        with:
          issue-number: ${{ github.event.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Release Domain Impact'

      - name: Create or Update Comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.number }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          body: ${{ steps.check.outputs.affected_output }}
          edit-mode: replace
