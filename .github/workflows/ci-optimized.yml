name: CI Optimized - Fast Build

on:
  push:
    branches:
      - main
      - develop
  pull_request:

permissions:
  actions: read
  contents: read

jobs:
  # Single job with shared node_modules to avoid redundant installs
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        timeout-minutes: 3

      - name: Setup Node.js with caching
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
        timeout-minutes: 2

      - name: Install dependencies (optimized)
        run: |
          echo "Installing dependencies for 2024 package project..."

          # Try npm ci first (fastest when it works)
          if npm ci --no-audit --no-fund --prefer-offline 2>/dev/null; then
            echo "npm ci completed successfully"
          else
            echo "npm ci failed, using npm install..."
            rm -f package-lock.json
            npm install --no-audit --no-fund --legacy-peer-deps
          fi

          echo "Installation completed"
        timeout-minutes: 12

      - name: Run linting
        run: |
          echo "Running linting..."
          npx nx run-many -t lint --parallel=2
        timeout-minutes: 4

      - name: Run tests
        run: |
          echo "Running tests..."
          npx nx run-many -t test --parallel=2
        timeout-minutes: 8

      - name: Build applications
        run: |
          echo "Building applications..."
          npx nx run-many -t build --parallel=2
        timeout-minutes: 6

  # Optional: Lightweight dependency audit in parallel
  security-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Quick security audit
        run: |
          npm audit --audit-level=high || echo "Security issues found but continuing"
        timeout-minutes: 3
