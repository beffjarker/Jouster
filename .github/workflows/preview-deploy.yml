name: Deploy Preview Environment

on:
  pull_request:
    branches: [develop]
    types: [opened, synchronize, reopened]

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        timeout-minutes: 3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
        timeout-minutes: 2

      - name: Install dependencies
        run: |
          echo "Installing dependencies with Angular CLI..."
          echo "Package.json dependency count:"
          cat package.json | grep -c '"' || echo "Could not count dependencies"

          # Set npm timeouts
          npm config set fetch-timeout 60000
          npm config set fetch-retry-mintimeout 10000
          npm config set fetch-retry-maxtimeout 60000

          # Delete package-lock.json and node_modules to force clean install
          # This is required to properly install Rollup optional dependencies
          # See: https://github.com/npm/cli/issues/4828
          echo "Removing package-lock.json and node_modules for clean install..."
          rm -rf node_modules package-lock.json

          echo "Running npm install (required for Rollup optional dependencies)..."
          npm install --no-audit --no-fund

          echo "Installation completed successfully"
          echo "Verifying packages..."
          ls node_modules/@angular/ >/dev/null && echo "âœ“ Angular packages found" || echo "âœ— Angular packages missing"
          ls node_modules/typescript/ >/dev/null && echo "âœ“ TypeScript found" || echo "âœ— TypeScript missing"
          ls node_modules/@rollup/ >/dev/null && echo "âœ“ Rollup packages found" || echo "âœ— Rollup packages missing"
        timeout-minutes: 8
        env:
          CI: true

      - name: Build application
        run: |
          echo "Building jouster-ui with Angular CLI..."
          npx ng build --configuration=development
        timeout-minutes: 8
        env:
          NODE_OPTIONS: --max_old_space_size=4096

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-west-2

      - name: Generate preview environment name
        id: preview-name
        run: |
          PR_NUMBER=${{ github.event.number }}
          PREVIEW_NAME="preview-pr-${PR_NUMBER}"
          echo "preview_name=${PREVIEW_NAME}" >> $GITHUB_OUTPUT
          echo "bucket_name=jouster-${PREVIEW_NAME}" >> $GITHUB_OUTPUT
          echo "cloudfront_comment=Jouster Preview PR ${PR_NUMBER}" >> $GITHUB_OUTPUT

      - name: Create S3 bucket for preview
        run: |
          BUCKET_NAME="${{ steps.preview-name.outputs.bucket_name }}"

          # Create bucket if it doesn't exist
          aws s3 mb s3://$BUCKET_NAME --region us-west-2 || echo "Bucket already exists"

          # Remove block public access settings to allow public bucket policy
          echo "Removing block public access settings..."
          aws s3api put-public-access-block \
            --bucket $BUCKET_NAME \
            --public-access-block-configuration \
            "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"

          # Configure bucket for static website hosting
          aws s3 website s3://$BUCKET_NAME --index-document index.html --error-document index.html

          # Set bucket policy for public read access
          cat > bucket-policy.json << EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "PublicReadGetObject",
                "Effect": "Allow",
                "Principal": "*",
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::$BUCKET_NAME/*"
              }
            ]
          }
          EOF

          aws s3api put-bucket-policy --bucket $BUCKET_NAME --policy file://bucket-policy.json

          echo "Bucket configured successfully for public website hosting"

      - name: Deploy to S3
        run: |
          BUCKET_NAME="${{ steps.preview-name.outputs.bucket_name }}"

          # Deploy built files (Angular CLI outputs to dist/jouster-ui)
          aws s3 sync dist/jouster-ui/ s3://$BUCKET_NAME --delete

          # Get the website URL
          WEBSITE_URL="http://$BUCKET_NAME.s3-website-us-west-2.amazonaws.com"
          echo "Preview deployed to: $WEBSITE_URL"
          echo "website_url=$WEBSITE_URL" >> $GITHUB_OUTPUT
        id: deploy

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const websiteUrl = '${{ steps.deploy.outputs.website_url }}';
            const previewName = '${{ steps.preview-name.outputs.preview_name }}';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ **Preview Environment Deployed!**

              **Preview URL:** ${websiteUrl}
              **Environment:** ${previewName}

              This preview will be automatically cleaned up when the PR is closed.`
            });

  cleanup-preview:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-west-2

      - name: Clean up preview environment
        run: |
          PR_NUMBER=${{ github.event.number }}
          BUCKET_NAME="jouster-preview-pr-${PR_NUMBER}"

          # Delete all objects in bucket
          aws s3 rm s3://${BUCKET_NAME} --recursive || true

          # Delete the bucket
          aws s3 rb s3://${BUCKET_NAME} || true

      - name: Comment cleanup on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ðŸ§¹ Preview Environment Cleaned Up

              The preview environment for this PR has been automatically cleaned up.

              Thanks for your contribution! ðŸŽ‰`
            });
