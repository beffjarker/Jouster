name: Deploy Preview Environment

on:
  pull_request:
    branches: [develop]
    types: [opened, synchronize, reopened]

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        timeout-minutes: 3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
        timeout-minutes: 2

      - name: Install dependencies with timeout protection
        run: |
          echo "Starting npm install with timeout protection..."
          echo "Package.json dependency count:"
          cat package.json | grep -c '"' || echo "Could not count dependencies"

          # Set shorter npm timeouts to prevent hanging
          npm config set fetch-timeout 30000
          npm config set fetch-retry-mintimeout 5000
          npm config set fetch-retry-maxtimeout 30000

          # Skip nx post-install to prevent hanging
          export NX_SKIP_NX_CACHE=true
          export CI=true

          # Function to install with timeout
          install_with_timeout() {
            local method="$1"
            local timeout_sec="$2"
            local extra_flags="$3"

            echo "Trying $method with ${timeout_sec}s timeout..."
            timeout ${timeout_sec}s bash -c "$method $extra_flags" && return 0 || return 1
          }

          # Strategy 1: npm ci with aggressive 3-minute timeout and ignore-scripts
          if install_with_timeout "npm ci" 180 "--no-audit --no-fund --prefer-offline --ignore-scripts"; then
            echo "npm ci completed successfully (with scripts skipped)"
          # Strategy 2: npm install with legacy-peer-deps and ignore-scripts
          elif rm -f package-lock.json && install_with_timeout "npm install" 180 "--no-audit --no-fund --legacy-peer-deps --ignore-scripts"; then
            echo "npm install with legacy-peer-deps completed successfully (with scripts skipped)"
          # Strategy 3: npm install with force and ignore-scripts
          elif install_with_timeout "npm install" 120 "--force --no-audit --no-fund --ignore-scripts"; then
            echo "npm install with --force completed successfully (with scripts skipped)"
          else
            echo "ERROR: All npm installation methods failed within timeout limits"
            exit 1
          fi

          echo "Installation completed - verifying critical packages..."
          ls node_modules/@angular/ >/dev/null && echo "âœ“ Angular packages found" || echo "âœ— Angular packages missing"
          ls node_modules/@nx/ >/dev/null && echo "âœ“ Nx packages found" || echo "âœ— Nx packages missing"
          ls node_modules/typescript/ >/dev/null && echo "âœ“ TypeScript found" || echo "âœ— TypeScript missing"
          ls node_modules/eslint-plugin-import/ >/dev/null && echo "âœ“ ESLint plugin-import found" || echo "âœ— ESLint plugin-import missing"
          ls node_modules/@angular-eslint/ >/dev/null && echo "âœ“ Angular ESLint packages found" || echo "âœ— Angular ESLint packages missing"
        timeout-minutes: 10
        env:
          NX_SKIP_NX_CACHE: true
          CI: true

      - name: Build application
        run: |
          echo "Building jouster-ui..."
          echo "Nx Daemon: Disabled for CI environment"
          npx nx build jouster-ui --configuration=development --skip-nx-cache --verbose
        timeout-minutes: 12
        env:
          NODE_OPTIONS: --max_old_space_size=4096
          NX_DAEMON: false
          NX_SKIP_NX_CACHE: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-west-2

      - name: Generate preview environment name
        id: preview-name
        run: |
          PR_NUMBER=${{ github.event.number }}
          PREVIEW_NAME="preview-pr-${PR_NUMBER}"
          echo "preview_name=${PREVIEW_NAME}" >> $GITHUB_OUTPUT
          echo "bucket_name=jouster-${PREVIEW_NAME}" >> $GITHUB_OUTPUT
          echo "cloudfront_comment=Jouster Preview PR ${PR_NUMBER}" >> $GITHUB_OUTPUT

      - name: Create S3 bucket for preview
        run: |
          BUCKET_NAME="${{ steps.preview-name.outputs.bucket_name }}"
          aws s3 mb s3://$BUCKET_NAME --region us-west-2 || echo "Bucket may already exist"

          # Configure bucket for static website hosting
          aws s3 website s3://$BUCKET_NAME --index-document index.html --error-document index.html

          # Remove public access blocks to allow public read access
          aws s3api delete-public-access-block --bucket $BUCKET_NAME || echo "Public access blocks may not exist"

          # Set bucket policy for public read access
          cat > bucket-policy.json << EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "PublicReadGetObject",
                "Effect": "Allow",
                "Principal": "*",
                "Action": "s3:GetObject",
                "Resource": "arn:aws:s3:::$BUCKET_NAME/*"
              }
            ]
          }
          EOF

          aws s3api put-bucket-policy --bucket $BUCKET_NAME --policy file://bucket-policy.json

      - name: Deploy to S3
        run: |
          aws s3 sync dist/apps/jouster-ui/ s3://${{ steps.preview-name.outputs.bucket_name }} --delete

      - name: Get preview URL
        id: preview-url
        run: |
          PREVIEW_URL="http://${{ steps.preview-name.outputs.bucket_name }}.s3-website-us-west-2.amazonaws.com"
          echo "url=${PREVIEW_URL}" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.preview-url.outputs.url }}';
            const prNumber = context.issue.number;

            // Find existing preview comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸš€ Preview Environment')
            );

            const commentBody = `## ðŸš€ Preview Environment

            Your preview environment has been deployed!

            **Preview URL:** ${previewUrl}

            This preview will be automatically updated when you push new commits to this PR.

            ---
            *Preview environments are automatically cleaned up when the PR is closed.*`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }

  cleanup-preview:
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-west-2

      - name: Clean up preview environment
        run: |
          PR_NUMBER=${{ github.event.number }}
          BUCKET_NAME="jouster-preview-pr-${PR_NUMBER}"

          # Delete all objects in bucket
          aws s3 rm s3://${BUCKET_NAME} --recursive || true

          # Delete the bucket
          aws s3 rb s3://${BUCKET_NAME} || true

      - name: Comment cleanup on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ðŸ§¹ Preview Environment Cleaned Up

              The preview environment for this PR has been automatically cleaned up.

              Thanks for your contribution! ðŸŽ‰`
            });
