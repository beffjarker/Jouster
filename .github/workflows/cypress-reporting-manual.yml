name: REPORTING Cypress Manual

on:
  workflow_dispatch:
    inputs:
      tag:
        type: string
        description: Tag of the tests you want to run
        required: true
        default: '@regression'
      browser:
        type: choice
        description: Browser you want tests to run on
        default: 'chrome'
        required: true
        options:
          - chrome
          - firefox
      projects:
        type: choice
        description: Project you want to tests to run on
        default: 'reporting-api-e2e'
        required: true
        options:
          - 'reporting-api-e2e'
      tests_per_machine:
        type: choice
        description: Number of tests to run on each machine
        required: true
        default: '10'
        options:
          - '5'
          - '10'
          - '15'
          - '20'
      test_env:
        type: choice
        description: Env you want to run your tests on
        default: uat
        required: true
        options:
          - qa
          - uat
      baseurl:
        type: string
        description: baseurl to run against
        default: 'https://reporting-auth-api-us-west-2.reporting-nonprod.awsext.repsrv.com/release-reporting-X-X-X'
        required: true

env:
  NODE_VERSION: '20.12.1'

permissions:
  id-token: write
  contents: read

jobs:
  environment:
    runs-on: ubuntu-latest

    steps:
      - name: Inputs Received
        run: |
          echo '### Base branch' >> $GITHUB_STEP_SUMMARY
          echo "${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_STEP_SUMMARY
          echo '### Inputs' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo '${{ toJSON(inputs) }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  cy-prep:
    runs-on: ubuntu-latest
    outputs:
      author: ${{ steps.cy-info.outputs.author }}
      branch: ${{ github.ref_name }}
      build-id: ${{ steps.cy-info.outputs.build-id }}
      email: ${{ steps.cy-info.outputs.email }}
      env: '${{ github.event.inputs.test_env }}'
      message: ${{ steps.cy-info.outputs.message }}
      remote: ${{ steps.cy-info.outputs.remote }}
      sha: ${{ steps.cy-info.outputs.sha }}
      projects: ${{ steps.instances.outputs.projects }}
      browser: ${{ github.event.inputs.browser }}
      has-projects: ${{ steps.cy-info.outputs.has-projects }}
      tag: ${{ github.event.inputs.tag }}

    steps:
      - name: ‚úîÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üéÅ Get Affected Base
        id: base
        run: |
          BASE="remotes/origin/master"
          echo "name=${BASE}" >> $GITHUB_OUTPUT

      - name: üéÅ Get Necessary Cypress information
        id: cy-info
        run: |
          AUTHOR=$(git log -1 --pretty=%an)
          EMAIL=$(git log -1 --pretty=%ae)
          BROWSER=${{ github.event.inputs.browser }}
          TAG=${{ github.event.inputs.tag }}
          PROJECTS=${{ github.event.inputs.projects }}
          REMOTE=$(git config --get remote.origin.url)
          SHA=$(git log -1 --pretty=%H)
          echo "author=${AUTHOR}" >> $GITHUB_OUTPUT
          echo "email=${EMAIL}" >> $GITHUB_OUTPUT
          echo "build-id=${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_OUTPUT
          echo "projects=${PROJECTS}" >> $GITHUB_OUTPUT
          echo "remote=${REMOTE}" >> $GITHUB_OUTPUT
          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "browser=${BROWSER}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "message<<$EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=%B >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: ‚ôæÔ∏è Set Instances
        id: instances
        run: |
          PROJECTS=$(./bin/set-instances-reporting-manual.sh ${{ github.event.inputs.projects }} ${{ github.event.inputs.tag }} ${{ github.event.inputs.tests_per_machine }})
          echo "Before assigning projects output"
          echo "projects=${PROJECTS}" >> $GITHUB_OUTPUT

  cypress-tests:
    name: üß™ Cypress Tests (API) [REPORTING]
    needs: [cy-prep]
    runs-on:
      group: self-hosted-nonprod
      labels: nonprod

    steps:
      - name: Process Build Id
        id: build-id
        run: |
          echo "${{ github.event.inputs.projects }}"
          echo ${{ needs.cy-prep.outputs.build-id }}
          echo "build-id=${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_OUTPUT

      - name: üñ®Ô∏è Print needed info
        run: |
          echo "Needed Information"
          echo "author: ${{ needs.cy-prep.outputs.author }}"
          echo "branch: ${{ github.ref_name }}"
          echo "build-id": ${{ steps.build-id.outputs.build-id }}
          echo "email: ${{ needs.cy-prep.outputs.email }}"
          echo "env: ${{ github.event.inputs.test_env }}"
          echo "message: ${{ needs.cy-prep.outputs.message }}"
          echo "project: ${{ github.event.inputs.projects }}"
          echo "remote: ${{ needs.cy-prep.outputs.remote }}"
          echo "sha: ${{ needs.cy-prep.outputs.sha }}"
          echo "record key: ${{ needs.cy-prep.outputs.record-key }}"
          echo "browser: ${{ github.event.inputs.browser }}"
          echo "tag: ${{ github.event.inputs.tag }}"

      - name: üéÅ Cypress Cloud Record Key Secret Name
        id: cy-cloud
        run: |
          RECORD_KEY=$(echo "${{github.event.inputs.projects}}_RECORD_KEY" | sed -e "s/-/_/g" | tr '[:lower:]' '[:upper:]')
          echo "RECORD_KEY: ${RECORD_KEY}"
          echo "record-key=${RECORD_KEY}" >> $GITHUB_OUTPUT

      - name: üîë Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.CYPRESS_OIDC_ROLE }}
          role-session-name: 'github_actions-cypress-reporting-manual'
          aws-region: us-west-2

      - name: Get SSM parameters
        id: ssm
        run: |
          echo "CY_AUTH0_CLIENT_SECRET=$(aws ssm get-parameter --name /digital/github/CY_AUTH0_CLIENT_SECRET --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_OUTPUT
          echo "REPORTING_API_X_API_KEY=$(aws ssm get-parameter --name /digital/github/REPORTING_API_X_API_KEY --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_OUTPUT
          echo "REPORTING_COR_SERVICE_X_API_KEY=$(aws ssm get-parameter --name /digital/github/REPORTING_COR_SERVICE_X_API_KEY --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_OUTPUT

      - name: ‚úîÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üß™ Cypress Tests (API) [REPORTING]
        id: cypress
        env:
          AUTHOR: ${{ needs.cy-prep.outputs.author }}
          BRANCH: ${{ needs.cy-prep.outputs.branch }}
          BROWSER: ${{ github.event.inputs.browser }}
          BASE_URL: ${{ github.event.inputs.baseurl }}
          BUILD_ID: ${{ steps.build-id.outputs.build-id }}
          CY_AUTH0_CLIENT_ID: ${{ vars.CY_AUTH0_CLIENT_ID }}
          CY_AUTH0_CLIENT_SECRET: ${{ steps.ssm.outputs.CY_AUTH0_CLIENT_SECRET }}
          EMAIL: ${{ needs.cy-prep.outputs.email }}
          ENV: '${{ github.event.inputs.test_env }}'
          MESSAGE: ${{ needs.cy-prep.outputs.message }}
          PROJECT: ${{ github.event.inputs.projects }}
          RECORD_KEY: ${{ vars[steps.cy-cloud.outputs.record-key] }}
          REMOTE: ${{ needs.cy-prep.outputs.remote }}
          REPUBLIC_SYSTEM_PAT: ${{ secrets.REPUBLIC_SYSTEM_PAT }}
          SHA: ${{ needs.cy-prep.outputs.sha }}
          TAG: ${{ github.event.inputs.tag }}
          XAPIKEY: ${{ github.event.inputs.projects == 'reporting-api-e2e' && steps.ssm.outputs.REPORTING_API_X_API_KEY }}
        run: |
          if [ "${{ github.event.inputs.projects }}" == "reporting-api-e2e" ]; then
            npx nx e2e reporting-api-e2e -- --env.grepTags=${TAG} --skipServe=true --record --key=${RECORD_KEY} --parallel --ci-build-id ${BUILD_ID} --group CI --browser ${BROWSER} --baseUrl=${BASE_URL} --env.env=${ENV} --env.CY_AUTH0_CLIENT_ID=${CY_AUTH0_CLIENT_ID} --env.CY_AUTH0_CLIENT_SECRET=${CY_AUTH0_CLIENT_SECRET} --env.xApiKey=${{ env.XAPIKEY }}
          fi

      - name: Set opslevel-service variable
        id: opslevel-service-var
        if: ${{ !cancelled() }}
        run: |
          PROJECT=$(echo "${{ github.event.inputs.projects }}" | sed -e "s/-/_/g" )
          echo "PROJECT: ${PROJECT}"
          echo "PROJECT=${PROJECT}" >> $GITHUB_ENV
          echo "OPSLEVEL_SERVICE=${PROJECT}" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: cypress-${{ github.event.inputs.projects }}-artifacts
          path: apps/${{ github.event.inputs.projects }}/reports

      - name: Report Cypress To Opslevel
        if: ${{ !cancelled() }}
        uses: RepublicServicesRepository/gha-cypress_to_opslevel@latest
        with:
          run-type: regression
          opslevel-service: ${{ steps.opslevel-service-var.outputs.OPSLEVEL_SERVICE }} #opslevel alias for the service
          report-path: apps/${{ github.event.inputs.projects }}/reports/index.json

  cypress-status:
    if: ${{ !cancelled() }}
    needs: [cy-prep, cypress-tests]
    runs-on: ubuntu-latest
    steps:
      - name: üñ®Ô∏è print cypress-smoke-tests result
        run: |
          echo "has-projects: ${{ needs.cy-prep.outputs.has-projects }}"
          echo "result: ${{ needs.cypress-tests.result }}"
          echo "proceed: ${{ needs.cypress-tests.result == 'success' }}"

      - name: ‚úîÔ∏è Check Cypress Matrix status
        if: ${{ needs.cypress-tests.result != 'success' }}
        run: exit 1
