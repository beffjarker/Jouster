# WIP - Unused as yet

name: Deploy RS MFE App
run-name: Deploy RS MFE App (${{ inputs.app-name }})

on:
  workflow_call:
    inputs:
      app-name:
        required: true
        type: string
      stage:
        required: true
        type: string
      environment:
        required: true
        type: string
      configuration:
        required: true
        type: string
      aws-role-to-assume:
        required: true
        type: string
      aws-region:
        required: true
        type: string
      github-ref:
        required: true
        type: string
      cloudfront-id:
        required: false
        type: string

permissions:
  id-token: write
  contents: read

env:
  ENVIRONMENT: ${{ inputs.environment }}
  NODE_VERSION: '20.12.1'
  NODE_OPTIONS: '--max_old_space_size=7168'

jobs:
  environment:
    runs-on: ubuntu-latest

    steps:
      - name: Inputs Received
        run: |
          echo '### Base branch' >> $GITHUB_STEP_SUMMARY
          echo "${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_STEP_SUMMARY
          echo '### Inputs' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo '${{ toJSON(inputs) }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  deploy-rs-frontend-prod:
    permissions:
      id-token: write
      contents: write

    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”‘ Configure AWS credentials
        uses: RepublicServicesRepository/gha-aws-configure-oidc-credentials@v1.0.0
        with:
          role-to-assume: ${{ inputs.aws-role-to-assume }}
          aws-region: ${{ inputs.aws-region }}

      - name: âœ”ï¸ Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.github-ref }}

      - name: ğŸ› ï¸ Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      # We use `run-many` here to avoid Nx complaining if an app does not have a given configuration
      - name: ğŸ›£ï¸ Create Infrastructure
        run: |
          npx nx run-many \
            --target=deploy \
            --projects='${{ inputs.app-name }}' \
            --stage=${{ inputs.stage }} \
            --configuration=${{ inputs.configuration }}

      - name: â¬†ï¸ Deploy Webapp to S3
        run: |
          npx nx sls ${{ matrix.project }} --command=syncToS3 --stage=${{ inputs.stage }}

      # TODO: Look this up dynamically (scripts/create-cf-invalidations.js needs enhancement)
      - name: ğŸš« Create CloudFront Invalidation
        if: inputs.cloudfront-id
        run: |
          aws cloudfront create-invalidation \
              --distribution-id ${{ inputs. cloudfront-id }} \
              --paths "/*"
