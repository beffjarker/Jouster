name: Deploy RSW Account App RC

on:
  push:
    branches:
      - release-rsw-*

env:
  ENVIRONMENT: uat
  NODE_VERSION: '20.12.1'
  NODE_OPTIONS: '--max_old_space_size=7168'

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.projects.outputs.projects }}

    steps:
      - uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Get Apps
        id: projects
        run: |
          PROJECTS=($(bin/get-apps.js -l rsw));
          PROJECTS_JSON=$(jq --compact-output --null-input '$ARGS.positional' --args -- "${PROJECTS[@]}" | jq -c -M '{"project": . }');
          echo "projects=${PROJECTS_JSON}" >> $GITHUB_OUTPUT
          echo ""
          echo "Projects to deploy:"
          echo ${PROJECTS[@]}

  deploy-release-candidate:
    needs: setup

    permissions:
      id-token: write
      contents: read

    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.projects) }}
    outputs:
      branch: ${{ steps.git-branch.outputs.name }}

    steps:
      - name: ‚úîÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_ref }}

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üå≥ Format branch name
        id: git-branch
        run: |
          BRANCH_NAME=$( \
            ./bin/format-branch-name.sh \
            --branch-name="${{ github.ref }}" \
            --field-separator=/
          )
          echo "name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

      - name: üîë Configure AWS credentials (RScom)
        uses: aws-actions/configure-aws-credentials@v4
        if: startsWith(matrix.project, 'rsw-')
        with:
          role-to-assume: ${{ vars.RSCOM_OIDC_SSO_DEV_ROLE }}
          role-session-name: 'github_actions-rscom_sso-dev'
          aws-region: us-west-2

      - name: üõ£Ô∏è Create Infrastructure
        env:
          STAGE: ${{ needs.setup.outputs.branch-name }}
        run: |
          npx nx run-many \
            --target=deploy \
            --projects='${{ matrix.project }}' \
            --stage=${{ steps.git-branch.outputs.name }} \
            --configuration=rc

  register-release-candidate:
    needs: deploy-release-candidate

    permissions:
      id-token: write
      contents: read

    runs-on: ubuntu-latest

    steps:
      - name: üîë Configure AWS credentials (RSCOM)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.RSCOM_OIDC_SSO_DEV_ROLE }}
          role-session-name: 'github_actions-rscom_sso-dev'
          aws-region: us-west-2

      - name: Register UI RC in RSCOM
        env:
          AWS_REGION: us-west-2
        run: |
          aws servicediscovery \
            register-instance \
            --service-id srv-qzqymzlfmt43l3cz \
            --instance-id rc \
            --attributes=BASE_URL=-${{ needs.deploy-release-candidate.outputs.branch }}.rscom-nonprod.awsext.repsrv.com
