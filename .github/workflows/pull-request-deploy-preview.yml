name: Deploy PR Preview Environment

on:
  workflow_dispatch:
  # DISABLED: npm install consistently times out in GitHub Actions
  # Use manual deployment: aws/scripts/deploy-preview-manual.bat <pr-number>
  # pull_request:
  #   types: [opened, synchronize, reopened]
  #   branches:
  #     - main
  #     - develop

permissions:
  pull-requests: write
  contents: read

jobs:
  deploy-preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'

      - name: Install dependencies with force flag
        run: npm ci --force --ignore-scripts
        timeout-minutes: 5

      - name: Build application
        run: npm run build:prod

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Generate preview bucket name
        id: bucket
        run: |
          # Create safe bucket name from PR number and branch
          BRANCH_NAME="${{ github.head_ref }}"
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-30)
          BUCKET_NAME="jouster-preview-pr${{ github.event.pull_request.number }}-${SAFE_BRANCH}"
          echo "name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "url=http://${BUCKET_NAME}.s3-website-us-west-2.amazonaws.com" >> $GITHUB_OUTPUT

      - name: Deploy to preview environment
        run: |
          chmod +x ./aws/scripts/deploy-preview.sh
          ./aws/scripts/deploy-preview.sh "${{ steps.bucket.outputs.name }}" "${{ github.event.pull_request.number }}"

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const previewUrl = '${{ steps.bucket.outputs.url }}';
            const prNumber = context.issue.number;

            // Check if a preview comment already exists
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ‰ Preview Environment Deployed')
            );

            const commentBody = `## ğŸ‰ Preview Environment Deployed!

            Your preview environment is ready for testing:

            ğŸ”— **Preview URL:** ${previewUrl}

            ğŸ“¦ **Bucket:** \`${{ steps.bucket.outputs.name }}\`
            ğŸ”¢ **PR:** #${prNumber}
            â° **Deployed:** ${new Date().toISOString()}

            ---

            ### ğŸ§ª Testing Instructions

            1. Click the preview URL above to test your changes
            2. Verify all functionality works as expected
            3. Test on different browsers if needed
            4. Report any issues in PR comments

            ### ğŸ§¹ Cleanup

            This preview environment will be automatically deleted when:
            - The PR is merged
            - The PR is closed
            - The preview is older than 7 days

            ---

            *This preview environment is deployed to AWS S3. It may take a minute for changes to propagate.*`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody,
              });
            }

      - name: Add preview label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['preview-deployed']
            });

