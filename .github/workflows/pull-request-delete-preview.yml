name: Delete PR Preview Environment

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - develop

env:
  AWS_REGION: us-west-2

permissions:
  pull-requests: write
  contents: read

jobs:
  cleanup-preview:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Generate preview bucket name
        id: bucket
        run: |
          PR_NUM="${{ github.event.pull_request.number }}"
          BUCKET_NAME="jouster-preview-pr${PR_NUM}"
          echo "name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "url=http://${BUCKET_NAME}.s3-website-us-west-2.amazonaws.com" >> $GITHUB_OUTPUT

      - name: Delete preview S3 bucket and contents
        run: |
          BUCKET_NAME="${{ steps.bucket.outputs.name }}"

          echo "üßπ Cleaning up preview environment for PR #${{ github.event.pull_request.number }}"
          echo "Bucket: ${BUCKET_NAME}"

          # Check if bucket exists
          if aws s3 ls "s3://${BUCKET_NAME}" 2>&1 | grep -q 'NoSuchBucket'; then
            echo "‚ö†Ô∏è  Bucket does not exist: ${BUCKET_NAME}"
            echo "Nothing to clean up."
          else
            echo "‚úÖ Bucket found: ${BUCKET_NAME}"

            # Delete all objects in the bucket (required before deleting bucket)
            echo "Deleting all objects in bucket..."
            aws s3 rm "s3://${BUCKET_NAME}" --recursive

            # Delete the bucket itself
            echo "Deleting bucket..."
            aws s3 rb "s3://${BUCKET_NAME}" --force

            echo "‚úÖ Bucket deleted successfully: ${BUCKET_NAME}"
          fi

      - name: Delete Route53 DNS records (if they exist)
        run: |
          BUCKET_NAME="${{ steps.bucket.outputs.name }}"
          DNS_NAME="${BUCKET_NAME}.jouster.org"

          echo "üîç Checking for DNS records for: ${DNS_NAME}"

          # Get hosted zone ID for jouster.org
          HOSTED_ZONE_ID=$(aws route53 list-hosted-zones \
            --query "HostedZones[?Name=='jouster.org.'].Id" \
            --output text 2>/dev/null | sed 's|/hostedzone/||')

          if [ -z "$HOSTED_ZONE_ID" ]; then
            echo "‚ö†Ô∏è  No Route53 hosted zone found for jouster.org"
            echo "No DNS records to clean up."
          else
            echo "‚úÖ Found hosted zone: ${HOSTED_ZONE_ID}"

            # Check if DNS record exists
            RECORD_EXISTS=$(aws route53 list-resource-record-sets \
              --hosted-zone-id "$HOSTED_ZONE_ID" \
              --query "ResourceRecordSets[?Name=='${DNS_NAME}.' && Type=='CNAME']" \
              --output text)

            if [ -z "$RECORD_EXISTS" ]; then
              echo "‚ö†Ô∏è  No DNS record found for ${DNS_NAME}"
            else
              echo "‚úÖ Found DNS record for ${DNS_NAME}, deleting..."

              # Delete the CNAME record
              aws route53 change-resource-record-sets \
                --hosted-zone-id "$HOSTED_ZONE_ID" \
                --change-batch "{
                  \"Changes\": [{
                    \"Action\": \"DELETE\",
                    \"ResourceRecordSet\": {
                      \"Name\": \"${DNS_NAME}.\",
                      \"Type\": \"CNAME\",
                      \"TTL\": 300,
                      \"ResourceRecords\": [{
                        \"Value\": \"${BUCKET_NAME}.s3-website-us-west-2.amazonaws.com\"
                      }]
                    }
                  }]
                }" && echo "‚úÖ DNS record deleted" || echo "‚ö†Ô∏è  DNS record deletion failed (may not exist)"
            fi
          fi

      - name: Delete CloudFront distribution (if it exists)
        run: |
          BUCKET_NAME="${{ steps.bucket.outputs.name }}"

          echo "üîç Checking for CloudFront distributions for: ${BUCKET_NAME}"

          # List CloudFront distributions and find any associated with this bucket
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?contains(Origins.Items[0].DomainName, '${BUCKET_NAME}')].Id" \
            --output text 2>/dev/null)

          if [ -z "$DISTRIBUTION_ID" ]; then
            echo "‚ö†Ô∏è  No CloudFront distribution found for ${BUCKET_NAME}"
          else
            echo "‚úÖ Found CloudFront distribution: ${DISTRIBUTION_ID}"
            echo "‚ö†Ô∏è  CloudFront deletion requires disabling first and waiting for deployment."
            echo "Skipping automatic CloudFront cleanup - manual intervention required."
            echo "To delete manually:"
            echo "  1. aws cloudfront get-distribution-config --id ${DISTRIBUTION_ID}"
            echo "  2. Disable the distribution"
            echo "  3. Wait for deployment (can take 15-20 minutes)"
            echo "  4. aws cloudfront delete-distribution --id ${DISTRIBUTION_ID}"
          fi

      - name: Comment cleanup status on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const bucketName = '${{ steps.bucket.outputs.name }}';
            const previewUrl = '${{ steps.bucket.outputs.url }}';

            const commentBody = `## üßπ Preview Environment Cleaned Up

            The preview environment for PR #${prNumber} has been successfully deleted.

            ### Deleted Resources

            ‚úÖ **S3 Bucket:** \`${bucketName}\`
            - All files and objects removed
            - Bucket deleted from AWS S3

            üîó **Preview URL (now inactive):** ~~${previewUrl}~~

            ### Cleanup Summary

            | Resource | Status |
            |----------|--------|
            | S3 Bucket | ‚úÖ Deleted |
            | Bucket Contents | ‚úÖ Removed |
            | DNS Records | ‚ö†Ô∏è  Checked (none found or removed) |
            | CloudFront Distribution | ‚ö†Ô∏è  Checked (none found) |

            ### Details

            - **PR:** #${prNumber}
            - **Bucket:** \`${bucketName}\`
            - **Cleaned up:** ${new Date().toISOString()}
            - **Triggered by:** PR ${context.payload.pull_request.merged ? 'merged' : 'closed'}

            ---

            *All preview environment resources have been removed from AWS. No further cleanup is required.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody,
            });

      - name: Remove preview label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'preview-deployed'
              });
            } catch (error) {
              console.log('Label may not exist:', error.message);
            }

      - name: Cleanup summary
        run: |
          echo "========================================="
          echo "üßπ Preview Environment Cleanup Complete"
          echo "========================================="
          echo ""
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "Bucket: ${{ steps.bucket.outputs.name }}"
          echo "Status: ${{ github.event.pull_request.merged && 'Merged' || 'Closed' }}"
          echo ""
          echo "Resources cleaned up:"
          echo "  ‚úÖ S3 Bucket deleted"
          echo "  ‚úÖ All files removed"
          echo "  ‚úÖ DNS records checked"
          echo "  ‚úÖ CloudFront checked"
          echo ""
          echo "Preview URL no longer accessible:"
          echo "  ${{ steps.bucket.outputs.url }}"
          echo ""
          echo "========================================="

