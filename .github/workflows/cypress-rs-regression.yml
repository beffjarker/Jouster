name: RS Cypress Regression
run-name: RS Cypress Regression (${{ github.event.inputs.projects }})

on:
  workflow_dispatch:
    inputs:
      browser:
        type: choice
        description: Browser you want tests to run on
        default: 'chrome'
        required: true
        options:
          - chrome
          - firefox
      projects:
        type: choice
        description: Project you want to tests to run on
        default: 'rs-frontend-e2e'
        required: true
        options:
          - 'rs-frontend-e2e'
          - 'rs-header-e2e'
          - 'rs-footer-e2e'
          - 'rs-shop-e2e'
      tests_per_machine:
        type: choice
        description: Number of tests to run on each machine
        required: true
        default: '10'
        options:
          - '5'
          - '10'
          - '15'
          - '20'

env:
  NODE_VERSION: '20.19.0'
  BASEURL: 'https://uat1.aws.repsrv.com'
  ENVIRONMENT: uat

permissions:
  id-token: write
  contents: read

jobs:
  environment:
    runs-on: ubuntu-latest

    steps:
      - name: Inputs Received
        run: |
          echo '### Base branch' >> $GITHUB_STEP_SUMMARY
          echo "${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_STEP_SUMMARY
          echo '### Inputs' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo '${{ toJSON(inputs) }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  cy-prep:
    runs-on: ubuntu-latest
    outputs:
      author: ${{ steps.cy-info.outputs.author }}
      baseurl: ${{ env.BASEURL }}
      branch: ${{ github.ref_name }}
      browser: ${{ github.event.inputs.browser }}
      build-id: ${{ steps.cy-info.outputs.build-id }}
      email: ${{ steps.cy-info.outputs.email }}
      env: ${{ env.ENVIRONMENT }}
      stable: ${{ steps.split-matrix.outputs.stable }}
      unstable: ${{ steps.split-matrix.outputs.unstable }}
      message: ${{ steps.cy-info.outputs.message }}
      projects: ${{ github.event.inputs.projects }}
      remote: ${{ steps.cy-info.outputs.remote }}
      record-key: ${{ steps.cy-cloud.outputs.record-key }}
      CYPRESS_REPORT_TOKEN: ${{ steps.ssm.outputs.CYPRESS_REPORT_TOKEN }}
      CY_AUTH0_CLIENT_SECRET: ${{ steps.ssm.outputs.CY_AUTH0_CLIENT_SECRET }}
      CY_AZURE_CLIENT_ID: ${{ steps.ssm.outputs.CY_AZURE_CLIENT_ID }}
      CY_AZURE_CLIENT_SECRET: ${{ steps.ssm.outputs.CY_AZURE_CLIENT_SECRET }}
      CY_AZURE_TENANT_ID: ${{ steps.ssm.outputs.CY_AZURE_TENANT_ID }}

    steps:
      - name: ‚úîÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Create local reference to master
        if: github.ref != 'refs/heads/master'
        run: git fetch origin master

      - name: üéÅ Get Affected Base
        id: base
        run: |
          BASE="remotes/origin/master"
          echo "name=${BASE}" >> $GITHUB_OUTPUT

      - name: üéÅ Cypress Cloud Record Key Secret Name
        id: cy-cloud
        run: |
          RECORD_KEY=$(echo "${{github.event.inputs.projects}}_RECORD_KEY" | sed -e "s/-/_/g" | tr '[:lower:]' '[:upper:]')
          echo "RECORD_KEY: ${RECORD_KEY}"
          echo "record-key=${RECORD_KEY}" >> $GITHUB_OUTPUT

      - name: üîë Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.CYPRESS_OIDC_ROLE }}
          role-session-name: 'github_actions-cypress-rs-manual'
          aws-region: us-west-2

      - name: Get SSM parameters
        id: ssm
        run: |
          echo "CY_AUTH0_CLIENT_SECRET=$(aws ssm get-parameter --name /digital/github/CY_AUTH0_CLIENT_SECRET --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_OUTPUT
          echo "CYPRESS_REPORT_TOKEN=$(aws ssm get-parameter --name /digital/github/CYPRESS_REPORT_TOKEN --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_OUTPUT
          echo "CY_AZURE_CLIENT_ID=$(aws ssm get-parameter --name /digital/github/CY_AZURE_CLIENT_ID --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_OUTPUT
          echo "CY_AZURE_CLIENT_SECRET=$(aws ssm get-parameter --name /digital/github/CY_AZURE_CLIENT_SECRET --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_OUTPUT
          echo "CY_AZURE_TENANT_ID=$(aws ssm get-parameter --name /digital/github/CY_AZURE_TENANT_ID --with-decryption --query 'Parameter.Value' --output text)" >> $GITHUB_OUTPUT

      - name: üéÅ Get Necessary Cypress information
        id: cy-info
        run: |
          AUTHOR=$(git log -1 --pretty=%an)
          EMAIL=$(git log -1 --pretty=%ae)
          BROWSER="${{ github.event.inputs.browser }}"
          PROJECTS="${{ github.event.inputs.projects }}"
          REMOTE=$(git config --get remote.origin.url)
          echo "author=${AUTHOR}" >> $GITHUB_OUTPUT
          echo "email=${EMAIL}" >> $GITHUB_OUTPUT
          echo "build-id=${{ github.run_id }}-${{ github.run_attempt }}" >> $GITHUB_OUTPUT
          echo "projects=${PROJECTS}" >> $GITHUB_OUTPUT
          echo "remote=${REMOTE}" >> $GITHUB_OUTPUT
          echo "browser=${BROWSER}" >> $GITHUB_OUTPUT
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "message<<$EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=%B >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Set matrix for cypress parallelization
        id: set-matrix
        shell: bash
        run: |
          # Get number of tests in each group
          PROJECTS="${{ github.event.inputs.projects }}"
          STABLE_COUNT=$(grep -Rl "@regression" "apps/${PROJECTS}/src/" 2>/dev/null \
          | while read -r file; do
              if ! grep -q "@fail" "$file" 2>/dev/null && ! grep -q "@flaky" "$file" 2>/dev/null; then
                echo "$file"
              fi
            done \
          | wc -l || true)

          FAILING_COUNT=$(grep -Rl "@regression" "apps/${PROJECTS}/src/" 2>/dev/null \
          | while read -r file; do
              if grep -q "@fail" "$file" ; then
                echo "$file"
              fi
            done \
          | wc -l)

          FLAKY_COUNT=$(grep -Rl "@regression" "apps/${PROJECTS}/src/" 2>/dev/null \
          | while read -r file; do
              if grep -q "@flaky" "$file" ; then
                echo "$file"
              fi
            done \
          | wc -l)

          # Calculate number of machines needed for each group
          TESTS_PER_MACHINE=${{ github.event.inputs.tests_per_machine }}
          MACHINES_STABLE=$(( (STABLE_COUNT + TESTS_PER_MACHINE - 1) / TESTS_PER_MACHINE ))
          MACHINES_FAILING=$(( (FAILING_COUNT + TESTS_PER_MACHINE - 1) / TESTS_PER_MACHINE ))
          MACHINES_FLAKY=$(( (FLAKY_COUNT + TESTS_PER_MACHINE - 1) / TESTS_PER_MACHINE ))

          echo "Number of tests in each group"
          echo "stable: $STABLE_COUNT, failing: $FAILING_COUNT, flaky: $FLAKY_COUNT"
          echo "Machines needed for each group"
          echo "stable: $MACHINES_STABLE, failing: $MACHINES_FAILING, flaky: $MACHINES_FLAKY"

          # Ensure jq is installed
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          # Build JSON for matrix
          JSON="{\"include\":["
          for i in $(seq 1 $MACHINES_STABLE); do
            JSON="${JSON}{\"group\":\"stable\",\"machine\":$i,\"greptags\":\"@regression+-@fail+-@flaky\"},"
          done
          for i in $(seq 1 $MACHINES_FAILING); do
            JSON="${JSON}{\"group\":\"failing\",\"machine\":$i,\"greptags\":\"@regression+@fail\"},"
          done
          for i in $(seq 1 $MACHINES_FLAKY); do
            JSON="${JSON}{\"group\":\"flaky\",\"machine\":$i,\"greptags\":\"@regression+@flaky\"},"
          done
          JSON="${JSON%,}]}" # Remove trailing comma and close JSON

          echo "Matrix: $JSON"
          echo "matrix=$JSON" >> $GITHUB_OUTPUT

      - name: Split matrix
        id: split-matrix
        shell: bash
        run: |
          matrix='${{ steps.set-matrix.outputs.matrix }}'

          #Use jq to filter stable vs failing/flaky
          STABLE_MATRIX=$(jq -c '{include: [.include[] | select(.group == "stable")]}' <<< "$matrix")
          echo "Stable matrix: $STABLE_MATRIX"
          UNSTABLE_MATRIX=$(jq -c '{include: [.include[] | select(.group != "stable")]}' <<< "$matrix")
          echo "Unstable matrix: $UNSTABLE_MATRIX"

          echo "STABLE=$STABLE_MATRIX" >> $GITHUB_OUTPUT
          echo "UNSTABLE=$UNSTABLE_MATRIX" >> $GITHUB_OUTPUT

  regression-tests-stable:
    name: regression-tests (${{ matrix.group }}-${{ matrix.machine }})
    needs: [cy-prep]
    if: join(fromJson(needs.cy-prep.outputs.stable).include) != ''
    runs-on:
      group: self-hosted-nonprod
      labels: nonprod
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.cy-prep.outputs.stable) }}
    outputs:
      CYPRESS_REPORT_TOKEN: ${{ needs.cy-prep.outputs.CYPRESS_REPORT_TOKEN }}
      cypress_run_number: ${{ steps.extract-run-details.outputs.cypress_run_number }}
      cypress_run_url: ${{ steps.extract-run-details.outputs.cypress_run_url }}

    steps:
      - name: üñ®Ô∏è Print needed info
        run: |
          echo "Needed Information"
          echo "author: ${{ needs.cy-prep.outputs.author }}"
          echo "branch: ${{ github.ref_name }}"
          echo "build-id: ${{ needs.cy-prep.outputs.build-id }}"
          echo "email: ${{ needs.cy-prep.outputs.email }}"
          echo "env: ${{ needs.cy-prep.outputs.env }}"
          echo "message: ${{ needs.cy-prep.outputs.message }}"
          echo "project: ${{ github.event.inputs.projects }}"
          echo "remote: ${{ needs.cy-prep.outputs.remote }}"
          echo "browser: ${{ needs.cy-prep.outputs.browser }}"
          echo "group: ${{ matrix.group }}"
          echo "machine: ${{ matrix.machine }}"

      - name: ‚úîÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üß™ Cypress Tests (UI) [RS]
        id: cypress
        env:
          AUTHOR: ${{ needs.cy-prep.outputs.author }}
          BRANCH: ${{ needs.cy-prep.outputs.branch }}
          BROWSER: ${{ needs.cy-prep.outputs.browser }}
          BASE_URL: ${{ needs.cy-prep.outputs.baseurl }}
          BUILD_ID: ${{ needs.cy-prep.outputs.build-id }}
          CY_AUTH0_CLIENT_ID: ${{ vars.CY_AUTH0_CLIENT_ID }}
          CY_AUTH0_CLIENT_SECRET: ${{ needs.cy-prep.outputs.CY_AUTH0_CLIENT_SECRET }}
          CY_AZURE_CLIENT_ID: ${{ needs.cy-prep.outputs.CY_AZURE_CLIENT_ID }}
          CY_AZURE_CLIENT_SECRET: ${{ needs.cy-prep.outputs.CY_AZURE_CLIENT_SECRET }}
          CY_AZURE_TENANT_ID: ${{ needs.cy-prep.outputs.CY_AZURE_TENANT_ID }}
          EMAIL: ${{ needs.cy-prep.outputs.email }}
          ENV: ${{ needs.cy-prep.outputs.env }}
          MESSAGE: ${{ needs.cy-prep.outputs.message }}
          PROJECT: ${{ github.event.inputs.projects }}
          RECORD_KEY: ${{ (github.event.inputs.projects == 'rs-shop-e2e' && vars[needs.cy-prep.outputs.record-key]) || secrets[needs.cy-prep.outputs.record-key] }}
          REMOTE: ${{ needs.cy-prep.outputs.remote }}
          REPUBLIC_SYSTEM_PAT: ${{ secrets.REPUBLIC_SYSTEM_PAT }}
          GREP_TAGS: ${{ matrix.greptags }}
          GROUP_VARS: ${{ matrix.group }}-${{ matrix.machine }}
        run: |
          # Debug project selection
          echo "Debug project selection:"
          echo "github.event.inputs.projects: ${{ github.event.inputs.projects }}"
          echo "PROJECT env var: ${PROJECT}"

          # Validate required variables
          if [ -z "$PROJECT" ]; then
            echo "Error: PROJECT is not set"
            exit 1
          fi
          if [ -z "$BROWSER" ]; then
            echo "Error: BROWSER is not set"
            exit 1
          fi
          if [ -z "$BASE_URL" ]; then
            echo "Error: BASE_URL is not set"
            exit 1
          fi
          if [ -z "$ENV" ]; then
            echo "Error: ENV is not set"
            exit 1
          fi

          # Run Cypress with validated variables
          npx nx e2e ${PROJECT} -- \
            --env.grepTags="${GREP_TAGS}" \
            --skipServe=true \
            --record \
            --key="${RECORD_KEY}" \
            --parallel \
            --ci-build-id "${BUILD_ID}" \
            --group regression-${{ matrix.group }} \
            --tag regression \
            --browser "${BROWSER}" \
            --baseUrl="${BASE_URL}" \
            --env.env="${ENV}" \
            --env.CY_AUTH0_CLIENT_ID="${CY_AUTH0_CLIENT_ID}" \
            --env.CY_AZURE_CLIENT_ID="${CY_AZURE_CLIENT_ID}" \
            --env.CY_AZURE_CLIENT_SECRET="${CY_AZURE_CLIENT_SECRET}" \
            --env.CY_AZURE_TENANT_ID="${CY_AZURE_TENANT_ID}" \
            --env.CY_AUTH0_CLIENT_SECRET="${CY_AUTH0_CLIENT_SECRET}" | tee cypress-output.log

      - name: Extract Cypress Run Details
        id: extract-run-details
        if: ${{ matrix.machine == 1 }}
        run: |
          RUN_URL=$(grep -oP 'https://cloud.cypress.io/projects/[a-zA-Z0-9]*/runs/[0-9]*' cypress-output.log | head -1 || echo "")
          echo "Extracted Cypress Run URL: $RUN_URL"
          echo "cypress_run_url=${RUN_URL}" >> "$GITHUB_OUTPUT"

          RUN_NUMBER=$(echo "$RUN_URL" | grep -o '[0-9]*$')
          if [ -n "$RUN_NUMBER" ]; then
            echo "cypress_run_number=${RUN_NUMBER}" >> "$GITHUB_OUTPUT"
            echo "Extracted Cypress Run Number: $RUN_NUMBER"
          else
            echo "Failed to extract Cypress run number"
            exit 1
          fi

      - name: Debug Before Upload
        if: ${{ !cancelled() }}
        continue-on-error: true
        run: |
          echo "Matrix GROUP_VARS value: ${{ matrix.group }}-${{ matrix.machine }}"
          echo "Looking for reports in:"
          find apps/${{ github.event.inputs.projects }}/reports/ -name "mochawesome*.json" -ls || echo "No files found in initial search"

      # Create a directory and copy files there before upload
      - name: Prepare Files for Upload
        if: ${{ !cancelled() }}
        continue-on-error: true
        run: |
          UPLOAD_DIR="reports-to-upload"
          mkdir -p $UPLOAD_DIR

          # Try to find and copy files, but don't fail if none found
          if find apps/${{ github.event.inputs.projects }}/reports/ -name "mochawesome*.json" -exec cp {} $UPLOAD_DIR/ \; ; then
            echo "Files copied successfully"
          else
            echo "No files found to copy"
          fi

          echo "Files ready for upload (if any):"
          ls -la $UPLOAD_DIR/ || echo "Upload directory is empty"

      # Upload the reports from each test run
      - name: Upload Reports
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: cypress-reports-${{ matrix.group }}-${{ matrix.machine }}
          path: reports-to-upload
          if-no-files-found: warn

      - name: Debug Report Location
        continue-on-error: true
        run: |
          echo "Matrix GROUP_VARS value: ${{ matrix.group }}-${{ matrix.machine }}"
          echo "Looking for reports in:"
          find apps/${{ github.event.inputs.projects }}/reports/ -name "mochawesome*.json" -ls

  regression-tests-unstable:
    name: regression-tests (${{ matrix.group }}-${{ matrix.machine }})
    needs: [cy-prep]
    if: join(fromJson(needs.cy-prep.outputs.unstable).include) != ''
    runs-on:
      group: self-hosted-nonprod
      labels: nonprod
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.cy-prep.outputs.unstable) }}

    steps:
      - name: üñ®Ô∏è Print needed info
        run: |
          echo "Needed Information"
          echo "author: ${{ needs.cy-prep.outputs.author }}"
          echo "branch: ${{ github.ref_name }}"
          echo "build-id: ${{ needs.cy-prep.outputs.build-id }}"
          echo "email: ${{ needs.cy-prep.outputs.email }}"
          echo "env: ${{ needs.cy-prep.outputs.env }}"
          echo "message: ${{ needs.cy-prep.outputs.message }}"
          echo "project: ${{ github.event.inputs.projects }}"
          echo "remote: ${{ needs.cy-prep.outputs.remote }}"
          echo "browser: ${{ needs.cy-prep.outputs.browser }}"
          echo "group: ${{ matrix.group }}"
          echo "machine: ${{ matrix.machine }}"

      - name: ‚úîÔ∏è Checkout
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üß™ Cypress Tests (UI) [RS]
        id: cypress
        env:
          AUTHOR: ${{ needs.cy-prep.outputs.author }}
          BRANCH: ${{ needs.cy-prep.outputs.branch }}
          BROWSER: ${{ needs.cy-prep.outputs.browser }}
          BASE_URL: ${{ needs.cy-prep.outputs.baseurl }}
          BUILD_ID: ${{ needs.cy-prep.outputs.build-id }}
          CY_AUTH0_CLIENT_ID: ${{ vars.CY_AUTH0_CLIENT_ID }}
          EMAIL: ${{ needs.cy-prep.outputs.email }}
          ENV: ${{ needs.cy-prep.outputs.env }}
          MESSAGE: ${{ needs.cy-prep.outputs.message }}
          PROJECT: ${{ github.event.inputs.projects }}
          RECORD_KEY: ${{ (github.event.inputs.projects == 'rs-shop-e2e' && vars[needs.cy-prep.outputs.record-key]) || secrets[needs.cy-prep.outputs.record-key] }}
          REMOTE: ${{ needs.cy-prep.outputs.remote }}
          REPUBLIC_SYSTEM_PAT: ${{ secrets.REPUBLIC_SYSTEM_PAT }}
          GREP_TAGS: ${{ matrix.greptags }}
          GROUP_VARS: ${{ matrix.group }}-${{ matrix.machine }}
        run: |
          # Debug project selection
          echo "Debug project selection:"
          echo "github.event.inputs.projects: ${{ github.event.inputs.projects }}"
          echo "PROJECT env var: ${PROJECT}"

          # Validate required variables
          if [ -z "$PROJECT" ]; then
            echo "Error: PROJECT is not set"
            exit 1
          fi
          if [ -z "$BROWSER" ]; then
            echo "Error: BROWSER is not set"
            exit 1
          fi
          if [ -z "$BASE_URL" ]; then
            echo "Error: BASE_URL is not set"
            exit 1
          fi
          if [ -z "$ENV" ]; then
            echo "Error: ENV is not set"
            exit 1
          fi

          # Run Cypress with validated variables
          npx nx e2e ${PROJECT} -- \
            --env.grepTags="${GREP_TAGS}" \
            --skipServe=true \
            --record \
            --key="${RECORD_KEY}" \
            --parallel \
            --ci-build-id "${BUILD_ID}" \
            --group regression-${{ matrix.group }} \
            --tag regression \
            --browser "${BROWSER}" \
            --baseUrl="${BASE_URL}" \
            --env.env="${ENV}" \
            --env.CY_AUTH0_CLIENT_ID="${CY_AUTH0_CLIENT_ID}" \
            --env.CY_AZURE_CLIENT_ID="${CY_AZURE_CLIENT_ID}" \
            --env.CY_AZURE_CLIENT_SECRET="${CY_AZURE_CLIENT_SECRET}" \
            --env.CY_AZURE_TENANT_ID="${CY_AZURE_TENANT_ID}" \
            --env.CY_AUTH0_CLIENT_SECRET="${CY_AUTH0_CLIENT_SECRET}" | tee cypress-output.log

      - name: Debug Before Upload
        if: ${{ !cancelled() }}
        continue-on-error: true
        run: |
          echo "Matrix GROUP_VARS value: ${{ matrix.group }}-${{ matrix.machine }}"
          echo "Looking for reports in:"
          find apps/${{ github.event.inputs.projects }}/reports/ -name "mochawesome*.json" -ls || echo "No files found in initial search"

      # Create a directory and copy files there before upload
      - name: Prepare Files for Upload
        if: ${{ !cancelled() }}
        continue-on-error: true
        run: |
          UPLOAD_DIR="reports-to-upload"
          mkdir -p $UPLOAD_DIR

          # Try to find and copy files, but don't fail if none found
          if find apps/${{ github.event.inputs.projects }}/reports/ -name "mochawesome*.json" -exec cp {} $UPLOAD_DIR/ \; ; then
            echo "Files copied successfully"
          else
            echo "No files found to copy"
          fi

          echo "Files ready for upload (if any):"
          ls -la $UPLOAD_DIR/ || echo "Upload directory is empty"

      # Upload the reports from each test run
      - name: Upload Reports
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: cypress-reports-${{ matrix.group }}-${{ matrix.machine }}
          path: reports-to-upload
          if-no-files-found: warn

      - name: Debug Report Location
        continue-on-error: true
        run: |
          echo "Matrix GROUP_VARS value: ${{ matrix.group }}-${{ matrix.machine }}"
          echo "Looking for reports in:"
          find apps/${{ github.event.inputs.projects }}/reports/ -name "mochawesome*.json" -ls

  # New job to merge reports after all tests complete
  merge-reports:
    needs: [regression-tests-stable, regression-tests-unstable]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - name: üñ•Ô∏è Setup Node Version
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # Download all reports to a specific directory
      - name: Download Reports
        uses: actions/download-artifact@v4
        with:
          pattern: cypress-reports-*
          merge-multiple: true
          path: downloaded-reports

      - name: Debug Downloaded Files
        run: |
          echo "Current directory structure:"
          pwd
          ls -R

          echo "\nLooking for mochawesome files:"
          find . -name "mochawesome*.json" -ls

          echo "\nContent of downloaded-reports:"
          ls -la downloaded-reports || echo "downloaded-reports directory not found"

          echo "\nFull directory tree:"
          tree || (apt-get update && apt-get install -y tree && tree)

      - name: Prepare Directory Structure
        run: |
          echo "Creating directory structure..."
          mkdir -p apps/${{ github.event.inputs.projects }}/reports/.jsons/

          echo "\nSearching for mochawesome files..."
          find downloaded-reports -name "mochawesome*.json" -print

          echo "\nCopying files..."
          if find downloaded-reports -name "mochawesome*.json" -exec cp {} apps/${{ github.event.inputs.projects }}/reports/.jsons/ \; ; then
            echo "Files copied successfully"
          else
            echo "No files found to copy"
            exit 1
          fi

          echo "\nVerifying copied files:"
          ls -la apps/${{ github.event.inputs.projects }}/reports/.jsons/

      - name: Install Dependencies
        run: |
          npm install -g mochawesome-merge mochawesome-report-generator
          sudo apt-get update && sudo apt-get install -y jq  # Install native jq instead of npm version

      - name: Merge Reports
        run: |
          echo "Current directory:"
          pwd

          echo "\nVerifying report files exist:"
          ls -la apps/${{ github.event.inputs.projects }}/reports/.jsons/

          echo "\nAttempting to merge reports..."
          mochawesome-merge "apps/${{ github.event.inputs.projects }}/reports/.jsons/mochawesome*.json" > "apps/${{ github.event.inputs.projects }}/reports/.jsons/index.json" || {
            echo "Error merging reports. Directory contents:"
            find . -name "mochawesome*.json" -ls
            exit 1
          }

      - name: Format Report
        run: |
          if [ -f "apps/${{ github.event.inputs.projects }}/reports/.jsons/index.json" ]; then
            /usr/bin/jq '
            def calc_pass_percent:
              if .stats.tests == 0 then 0
              else (.stats.passes / .stats.tests * 100) | floor
              end;
            {
              stats: {
                suites: .stats.suites,
                tests: .stats.tests,
                passes: .stats.passes,
                pending: .stats.pending,
                failures: .stats.failures,
                duration: .stats.duration,
                passPercent: calc_pass_percent,
                start: .stats.start,
                end: .stats.end
              },
              results: [.results[] | {
                suites: .suites,
                tests: .tests,
                passes: .passes,
                pending: .pending,
                failures: .failures,
                duration: .duration,
                fullFile: .fullFile,
                file: .file,
                title: .title,
                failedTests: [.suites[].tests[] | select(.fail == true) | {
                  title: .title,
                  code: .code,
                  err: .err
                }]
              }]
            }' "apps/${{ github.event.inputs.projects }}/reports/.jsons/index.json" > "apps/${{ github.event.inputs.projects }}/reports/.jsons/formatted.json"

            mv "apps/${{ github.event.inputs.projects }}/reports/.jsons/formatted.json" "apps/${{ github.event.inputs.projects }}/reports/.jsons/index.json"
          else
            echo "index.json not found!"
            exit 1
          fi

      - name: Set opslevel-service variable
        id: opslevel-service-var
        if: ${{ !cancelled() && (github.event.inputs.projects == 'rs-frontend-e2e' || github.event.inputs.projects == 'rs-shop-e2e' || github.event.inputs.projects == 'rs-footer-e2e' || github.event.inputs.projects == 'rs-header-e2e') }}
        run: |
          PROJECT=${{ github.event.inputs.projects }}
          PROJECT_FORMATTED=$(echo "$PROJECT" | sed -e "s/-/_/g" )
          echo "PROJECT: ${PROJECT_FORMATTED}"
          echo "Setting opslevel-service variable for project: $PROJECT"
          echo "opslevel-service=${PROJECT_FORMATTED}" >> $GITHUB_OUTPUT

      - name: Report Cypress To Opslevel
        if: ${{ !cancelled() && (github.event.inputs.projects == 'rs-frontend-e2e' || github.event.inputs.projects == 'rs-shop-e2e' || github.event.inputs.projects == 'rs-footer-e2e' || github.event.inputs.projects == 'rs-header-e2e') }}
        uses: RepublicServicesRepository/gha-cypress_to_opslevel@latest
        with:
          run-type: regression
          opslevel-service: ${{ steps.opslevel-service-var.outputs.opslevel-service }}
          report-path: apps/${{ github.event.inputs.projects }}/reports/.jsons/index.json

  cypress-cloud-run:
    name: Cypress Cloud Run
    if: ${{ !cancelled() }}
    needs: [regression-tests-stable, regression-tests-unstable]
    runs-on: ubuntu-latest
    steps:
      - name: Cypress Cloud Run
        id: cloud-run-url
        run: |
          RUN_URL=${{ needs.regression-tests-stable.outputs.cypress_run_url }}

          echo "### Cypress Cloud Run" >> $GITHUB_STEP_SUMMARY
          echo "URL: $RUN_URL" >> $GITHUB_STEP_SUMMARY

  cypress-extract-results:
    name: Cypress Extract Test Results
    if: ${{ !cancelled() }}
    needs: [regression-tests-stable, regression-tests-unstable]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üîë Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.CYPRESS_OIDC_ROLE }}
          role-session-name: 'github_actions-cypress-rs-manual-extract'
          aws-region: us-west-2

      - name: Extract Test Results
        run: |
          rm -f scripts/extract-regression-results/output/test-results.csv
          npx ts-node scripts/extract-regression-results/extract-cypress-results.ts
        env:
          CYPRESS_REPORT_TOKEN: ${{ needs.regression-tests-stable.outputs.CYPRESS_REPORT_TOKEN }}
          BRANCH_NAME: ${{ github.ref_name }}
          CYPRESS_RUN_NUMBER: ${{ needs.regression-tests-stable.outputs.cypress_run_number }}
          CYPRESS_PROJECT_NAME: ${{ github.event.inputs.projects == 'rs-shop-e2e' && github.event.inputs.projects || format('digital-platform-{0}', github.event.inputs.projects) }}

      - name: Upload Results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: cypress-test-results-${{ github.event.inputs.projects }}-${{ needs.regression-tests-stable.outputs.cypress_run_number }}
          path: ${{ github.event.inputs.projects == 'rs-shop-e2e' && format('scripts/extract-regression-results/output/{0}-{1}.csv', github.event.inputs.projects, needs.regression-tests-stable.outputs.cypress_run_number) || format('scripts/extract-regression-results/output/digital-platform-{0}-{1}.csv', github.event.inputs.projects, needs.regression-tests-stable.outputs.cypress_run_number) }}
          retention-days: 5

  cypress-regression-status:
    name: Cypress Regression Quality Checks Passed
    if: ${{ !cancelled() }}
    needs: [regression-tests-stable]
    runs-on: ubuntu-latest
    steps:
      - name: üñ®Ô∏è Print Status
        run: |
          echo "Test Result: ${{ needs.regression-tests-stable.result }}"

      - name: ‚úîÔ∏è Check Cypress Regression Matrix status
        if: ${{ needs.regression-tests-stable.result == 'failure' }}
        run: exit 1
