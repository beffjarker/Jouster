name: Integration test Ecommerce

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      branch-name:
        description: 'The branch name to run the test'
        required: true
        type: string
      projects:
        description: 'Get the list of projects for any project specific jobs'
        required: true
        type: string
    secrets:
      ECOM_OIDC_SSO_DEV_ROLE:
        required: true

env:
  NODE_VERSION: '20.19.0'

jobs:
  environment:
    runs-on: ubuntu-latest

    steps:
      - name: Inputs Received
        run: |
          echo '### Base branch' >> $GITHUB_STEP_SUMMARY
          echo "${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_STEP_SUMMARY
          echo '### Inputs' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo '${{ toJSON(inputs) }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  integration-test-ecom:
    permissions:
      id-token: write
      contents: read

    name: run ecom e2e tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(inputs.projects) }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ› ï¸ Setup Node.js and Install Dependencies
        uses: ./.github/actions/setup-node-install
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure AWS credentials (ECom)
        uses: aws-actions/configure-aws-credentials@v4
        if: startsWith(matrix.project, 'ecom-')
        with:
          role-to-assume: ${{ vars.ECOM_OIDC_SSO_DEV_ROLE }}
          role-session-name: 'github_actions-rscom_ecom_sso-dev'
          aws-region: us-west-2

      - name: get RestApiId for creating preview url
        id: get-restApiId
        run: |
          RESTAPIIDSHOP=$(./bin/get-restApiId.sh "${{ inputs.branch-name }}-ecom-shop-api")
          echo "restApiIdShop=${RESTAPIIDSHOP}" >> $GITHUB_OUTPUT

      - name: Run integration test for ecom-shop-api
        if: startsWith(matrix.project, 'ecom-shop-api')
        run: |
          npx nx run-many --target=e2e --projects=ecom-shop-api-e2e --baseUrl="https://${{steps.get-restApiId.outputs.restApiIdShop}}.execute-api.us-west-2.amazonaws.com/${{inputs.branch-name}}" --skipServe
