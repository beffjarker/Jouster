name: QA Deployment to qa.jouster.org

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]
    types: [closed]

env:
  NODE_OPTIONS: '--max_old_space_size=7168'

permissions:
  id-token: write
  contents: read

jobs:
  deploy-qa:
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    environment:
      name: qa
      url: https://qa.jouster.org

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.19.0'

    - name: Cache node_modules
      id: cache-node-modules
      uses: actions/cache@v4
      with:
        path: node_modules
        key: node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          node-modules-${{ runner.os }}-

    - name: Install dependencies
      if: steps.cache-node-modules.outputs.cache-hit != 'true'
      run: npm install --prefer-offline --no-audit --no-fund
      timeout-minutes: 25
      env:
        NODE_OPTIONS: '--max_old_space_size=7168'

    - name: Build application for QA
      run: |
        npm run build:prod
        echo "Built jouster-ui for QA environment"
      env:
        NODE_OPTIONS: '--max_old_space_size=7168'

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2

    - name: Create QA S3 bucket if not exists
      run: |
        if ! aws s3api head-bucket --bucket qa.jouster.org 2>/dev/null; then
          echo "Creating QA S3 bucket..."
          aws s3 mb s3://qa.jouster.org --region us-west-2

          # Configure bucket for static website hosting
          aws s3 website s3://qa.jouster.org --index-document index.html --error-document index.html

          # Remove public access blocks
          aws s3api put-public-access-block \
            --bucket qa.jouster.org \
            --public-access-block-configuration "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"

          # Apply public read policy
          aws s3api put-bucket-policy \
            --bucket qa.jouster.org \
            --policy '{
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "PublicReadGetObject",
                  "Effect": "Allow",
                  "Principal": "*",
                  "Action": "s3:GetObject",
                  "Resource": "arn:aws:s3:::qa.jouster.org/*"
                }
              ]
            }'
          echo "QA S3 bucket created and configured"
        else
          echo "QA S3 bucket already exists"
        fi

    - name: Deploy to QA S3 bucket
      run: |
        echo "Deploying to QA environment..."
        aws s3 sync dist/apps/jouster-ui/browser/ s3://qa.jouster.org --delete --region us-west-2
        echo "‚úÖ Deployment to qa.jouster.org complete!"

    - name: Setup QA DNS if needed
      run: |
        # Check if QA DNS record exists
        HOSTED_ZONE_ID=$(aws route53 list-hosted-zones --query "HostedZones[?Name=='jouster.org.'].Id" --output text | sed 's|/hostedzone/||')

        if [ -n "$HOSTED_ZONE_ID" ]; then
          # Check if qa.jouster.org CNAME record exists
          RECORD_EXISTS=$(aws route53 list-resource-record-sets \
            --hosted-zone-id $HOSTED_ZONE_ID \
            --query "ResourceRecordSets[?Name=='qa.jouster.org.' && Type=='CNAME']" \
            --output text)

          if [ -z "$RECORD_EXISTS" ]; then
            echo "Creating DNS record for qa.jouster.org..."
            aws route53 change-resource-record-sets \
              --hosted-zone-id $HOSTED_ZONE_ID \
              --change-batch '{
                "Changes": [{
                  "Action": "CREATE",
                  "ResourceRecordSet": {
                    "Name": "qa.jouster.org.",
                    "Type": "CNAME",
                    "TTL": 300,
                    "ResourceRecords": [{
                      "Value": "qa.jouster.org.s3-website-us-west-2.amazonaws.com"
                    }]
                  }
                }]
              }'
            echo "‚úÖ DNS record created for qa.jouster.org"
          else
            echo "DNS record for qa.jouster.org already exists"
          fi
        else
          echo "‚ö†Ô∏è No hosted zone found for jouster.org - QA will be accessible via S3 endpoint only"
        fi

    - name: Post deployment info
      run: |
        echo "üöÄ QA Deployment Complete!"
        echo "QA Environment URLs:"
        echo "- Custom Domain: https://qa.jouster.org (if DNS configured)"
        echo "- S3 Direct: http://qa.jouster.org.s3-website-us-west-2.amazonaws.com"
        echo "- Build: ${{ github.sha }}"
        echo "- Branch: ${{ github.ref_name }}"
