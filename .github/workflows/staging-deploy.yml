name: Staging Deployment to stg.jouster.org

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [closed]

permissions:
  id-token: write
  contents: read

jobs:
  deploy-staging:
    if: github.event_name == 'push' || (github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    environment:
      name: staging
      url: https://stg.jouster.org

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm ci || {
          echo "npm ci failed, falling back to npm install"
          rm -rf node_modules package-lock.json
          npm install
        }

    - name: Build application for staging
      run: |
        npm run build:prod
        echo "Built for staging environment"

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::924677642513:role/GitHubActionsPreviewRole
        aws-region: us-west-2

    - name: Create staging S3 bucket if not exists
      run: |
        if ! aws s3api head-bucket --bucket stg.jouster.org 2>/dev/null; then
          echo "Creating staging S3 bucket..."
          aws s3 mb s3://stg.jouster.org --region us-west-2

          # Configure bucket for static website hosting
          aws s3 website s3://stg.jouster.org --index-document index.html --error-document index.html

          # Remove public access blocks
          aws s3api put-public-access-block \
            --bucket stg.jouster.org \
            --public-access-block-configuration "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"

          # Apply public read policy
          aws s3api put-bucket-policy \
            --bucket stg.jouster.org \
            --policy '{
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "PublicReadGetObject",
                  "Effect": "Allow",
                  "Principal": "*",
                  "Action": "s3:GetObject",
                  "Resource": "arn:aws:s3:::stg.jouster.org/*"
                }
              ]
            }'
          echo "Staging S3 bucket created and configured"
        else
          echo "Staging S3 bucket already exists"
        fi

    - name: Deploy to staging S3 bucket (green environment)
      run: |
        echo "Deploying to staging environment (green)..."
        aws s3 sync dist/jouster/browser/ s3://stg.jouster.org --delete --region us-west-2
        echo "‚úÖ Deployment to stg.jouster.org complete!"

    - name: Setup staging DNS if needed
      run: |
        # Check if staging DNS record exists
        HOSTED_ZONE_ID=$(aws route53 list-hosted-zones --query "HostedZones[?Name=='jouster.org.'].Id" --output text | sed 's|/hostedzone/||')

        if [ -n "$HOSTED_ZONE_ID" ]; then
          # Check if stg.jouster.org CNAME record exists
          RECORD_EXISTS=$(aws route53 list-resource-record-sets \
            --hosted-zone-id $HOSTED_ZONE_ID \
            --query "ResourceRecordSets[?Name=='stg.jouster.org.' && Type=='CNAME']" \
            --output text)

          if [ -z "$RECORD_EXISTS" ]; then
            echo "Creating DNS record for stg.jouster.org..."
            aws route53 change-resource-record-sets \
              --hosted-zone-id $HOSTED_ZONE_ID \
              --change-batch '{
                "Changes": [{
                  "Action": "CREATE",
                  "ResourceRecordSet": {
                    "Name": "stg.jouster.org.",
                    "Type": "CNAME",
                    "TTL": 300,
                    "ResourceRecords": [{
                      "Value": "stg.jouster.org.s3-website-us-west-2.amazonaws.com"
                    }]
                  }
                }]
              }'
            echo "‚úÖ DNS record created for stg.jouster.org"
          else
            echo "DNS record for stg.jouster.org already exists"
          fi
        else
          echo "‚ö†Ô∏è No hosted zone found for jouster.org - staging will be accessible via S3 endpoint only"
        fi

    - name: Post deployment info
      run: |
        echo "üöÄ Staging Deployment Complete!"
        echo "Staging Environment URLs:"
        echo "- Custom Domain: https://stg.jouster.org"
        echo "- S3 Direct: http://stg.jouster.org.s3-website-us-west-2.amazonaws.com"
        echo "- Build: ${{ github.sha }}"
        echo "- Branch: ${{ github.ref_name }}"
        echo "- Environment: GREEN (Staging)"
